<!doctype html><html lang=en-uk><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework</title><meta property="og:title" content="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework"><meta name=twitter:title content="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework"><meta name=description content="Building Least Privilege Permissions in AWS using Serverless Framework as an example"><meta property="og:description" content="Building Least Privilege Permissions in AWS using Serverless Framework as an example"><meta name=twitter:description content="Building Least Privilege Permissions in AWS using Serverless Framework as an example"><meta name=author content="Dave Kerr"><meta property="og:site_name" content="dwmkerr.com"><meta property="og:url" content="https://dwmkerr.com/building-least-privilege-permissions-aws/"><meta name=twitter:card content="summary"><meta name=twitter:site content="@dwmkerr"><meta name=twitter:creator content="@dwmkerr"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.61.0"><link rel=stylesheet href=https://dwmkerr.com/css/style.css><link rel=icon type=image/x-icon href=https://dwmkerr.com/images/favicon.ico><script type=text/javascript src=https://dwmkerr.com/js/bundle.js></script></head><body><a href=#main class="skip-link p-screen-reader-text">Skip to content</a><svg xmlns="http://www.w3.org/2000/svg" style="display:none" aria-hidden="true"><symbol id="icon-500px" viewBox="0 0 16 16"><g><path d="M3.953 10.512a5.24 5.24.0 006.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122a5.226 5.226.0 00-2.037-.413c-.716.0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491.0-.122.0-.487-.266-.491H4.377a.343.343.0 00-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262.0 013.037-1.25c1.147.0 2.222.444 3.028 1.25a4.245 4.245.0 011.256 3.019 4.236 4.236.0 01-1.25 3.019 4.336 4.336.0 01-3.047 1.25 4.136 4.136.0 01-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09.0 011.588-.716c.594.0 1.15.225 1.566.634.409.406.637.95.637 1.528a2.179 2.179.0 01-2.206 2.197c-.238.0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173.0 003.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856.0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181.0 00.131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088.0.184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16.0 00-.113-.047c-.078.0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938.0-1.938.191-2.669.506a.207.207.0 00-.134.181.753.753.0 00.069.337c.047.116.166.425.4.334a6.689 6.689.0 012.334-.444 6.35 6.35.0 012.469.497c.622.263 1.206.644 1.844 1.194a.22.22.0 00.147.059c.125.0.244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858.0 00-2.1-1.356 7.326 7.326.0 00-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32.0 01-6.938 1.356 6.336 6.336.0 01-2.013-1.356 6.046 6.046.0 01-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261.0 002.04 3.994 7.266 7.266.0 0010.288.0l.059-.059c.069-.084.134-.225-.159-.516z"/></g></symbol><symbol id="icon-codepen" viewBox="0 0 16 16"><g><path d="M14.777 5.751l-7-4.667a.5.5.0 00-.555.0l-7 4.667a.501.501.0 00-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5.0 00.554.0l7-4.667a.501.501.0 00.223-.416V6.167a.501.501.0 00-.223-.416zM7.5 10.232 4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5 1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2 3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5 14 7.101v2.798L11.901 8.5z"/></g></symbol><symbol id="icon-dribbble" viewBox="0 0 16 16"><g><path d="M8 16c-4.412.0-8-3.588-8-8s3.587-8 8-8c4.412.0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7.0 011.328 4.872 6.845 6.845.0 002.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807.0 006.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04.0 01.269-.081 24.04 24.04.0 00-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209.0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831a43.092 43.092.0 00-2.534-3.953A6.854 6.854.0 001.314 6.609zM6.4 1.366a36.612 36.612.0 012.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799.0 006.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219a6.816 6.816.0 00-1.544-4.256z"/></g></symbol><symbol id="icon-facebook" viewBox="0 0 16 16"><g><path d="M9.5 3H12V0H9.5C7.57.0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/></g></symbol><symbol id="icon-feed" viewBox="0 0 16 16"><g><path d="M2.13 11.733c-1.175.0-2.13.958-2.13 2.126.0 1.174.955 2.122 2.13 2.122a2.126 2.126.0 002.133-2.122A2.133 2.133.0 002.13 11.733zM.002 5.436v3.067c1.997.0 3.874.781 5.288 2.196a7.45 7.45.0 012.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006.0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824.0.006.0z"/></g></symbol><symbol id="icon-flickr" viewBox="0 0 16 16"><g><path d="M0 8.5a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0zm9 0a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0z"/></g></symbol><symbol id="icon-github" viewBox="0 0 16 16"><g><path d="M8 .198A8 8 0 005.471 15.789c.4.074.547-.174.547-.385.0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954.0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117.0.0.672-.215 2.201.82A7.672 7.672.0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147.0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481.0 1.07-.009 1.932-.009 2.195.0.213.144.462.55.384A8 8 0 008.001.196z"/></g></symbol><symbol id="icon-gitlab" viewBox="0 0 28 28"><g><path d="M1.625 11.031 14 26.89.437 17.046a1.092 1.092.0 01-.391-1.203l1.578-4.813zm7.219.0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548.0 011.031.0zm20.625 9.562 1.578 4.813a1.09 1.09.0 01-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548.0 011.031.0z"/></g></symbol><symbol id="icon-google-plus" viewBox="0 0 16 16"><g><path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737.0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991.0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784.0 5.059.0 7.875s2.275 5.091 5.091 5.091c2.937.0 4.888-2.066 4.888-4.975.0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/></g></symbol><symbol id="icon-instagram" viewBox="0 0 22 22"><g><path d="M15.445.0H6.554A6.559 6.559.0 000 6.554v8.891A6.559 6.559.0 006.554 22h8.891a6.56 6.56.0 006.554-6.555V6.554A6.557 6.557.0 0015.445.0zm4.342 15.445a4.343 4.343.0 01-4.342 4.342H6.554a4.341 4.341.0 01-4.341-4.342V6.554a4.34 4.34.0 014.341-4.341h8.891a4.342 4.342.0 014.341 4.341l.001 8.891z"/><path d="M11 5.312A5.693 5.693.0 005.312 11 5.694 5.694.0 0011 16.688 5.694 5.694.0 0016.688 11 5.693 5.693.0 0011 5.312zm0 9.163a3.475 3.475.0 11-.001-6.95 3.475 3.475.0 01.001 6.95zm5.7-10.484a1.363 1.363.0 11-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/></g></symbol><symbol id="icon-linkedin" viewBox="0 0 16 16"><g><path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502.0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5a1.5 1.5.0 11-3.001-.001A1.5 1.5.0 014 3.5z"/></g></symbol><symbol id="icon-mail" viewBox="0 0 22 18"><g><path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275 5.077-5.09L1.795 3.98v10.155zm13.332-5.09 5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588 8.022-8.027-16.045-.001 8.023 8.028z"/></g></symbol><symbol id="icon-medium" viewBox="0 0 24 24"><g><path d="M22.085 4.733 24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244.0 01-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287.0.346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556.0 01-.214-.534V5.267a.554.554.0 01.213-.534z"/></g></symbol><symbol id="icon-npm" viewBox="0 0 16 16"><g><path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/></g></symbol><symbol id="icon-pinterest" viewBox="0 0 16 16"><g><path d="M8 1.069A6.93 6.93.0 005.475 14.453c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591.0.878.444.878.975.0.594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231.0 2.178-1.3 2.178-3.175.0-1.659-1.194-2.819-2.894-2.819-1.972.0-3.128 1.478-3.128 3.009.0.597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89.0 01-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684.0-2.188 1.587-4.194 4.578-4.194 2.403.0 4.272 1.712 4.272 4.003.0 2.388-1.506 4.313-3.597 4.313-.703.0-1.362-.366-1.588-.797.0.0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93.0 008.984-6.622 6.931 6.931.0 00-6.931-6.934z"/></g></symbol><symbol id="icon-search" viewBox="0 0 16 16"><g><path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 10-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 110-8 4 4 0 010 8z"/></g></symbol><symbol id="icon-strava" viewBox="0 0 24 24"><g><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599 2.836 5.598h4.172L10.463.0l-7 13.828h4.169"/></g></symbol><symbol id="icon-tumblr" viewBox="0 0 16 16"><g><path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81.0 1.289-.107 2.09-.633v2.405a9.089 9.089.0 01-1.833.639A7.93 7.93.0 019.369 16a4.9 4.9.0 01-1.725-.276 4.195 4.195.0 01-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386.0 001.08-1.374C6.133 1.505 6.32.825 6.422.0h2.579v4H13v3H9.001z"/></g></symbol><symbol id="icon-twitter" viewBox="0 0 16 16"><g><path d="M16 3.538a6.461 6.461.0 01-1.884.516 3.301 3.301.0 001.444-1.816 6.607 6.607.0 01-2.084.797 3.28 3.28.0 00-2.397-1.034 3.28 3.28.0 00-3.197 4.028 9.321 9.321.0 01-6.766-3.431 3.284 3.284.0 001.015 4.381A3.301 3.301.0 01.643 6.57v.041A3.283 3.283.0 003.277 9.83a3.291 3.291.0 01-1.485.057 3.293 3.293.0 003.066 2.281 6.586 6.586.0 01-4.862 1.359 9.286 9.286.0 005.034 1.475c6.037.0 9.341-5.003 9.341-9.341.0-.144-.003-.284-.009-.425a6.59 6.59.0 001.637-1.697z"/></g></symbol><symbol id="icon-vimeo" viewBox="0 0 16 16"><g><path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931.0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119.0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334.0.838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98.0 00-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/></g></symbol><symbol id="icon-wordpress" viewBox="0 0 16 16"><g><path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693.0 002 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371.0-.537.418-1.037 1.008-1.037.027.0.052.003.078.005A6.064 6.064.0 008 2.156 6.036 6.036.0 002.987 4.79c.141.004.274.007.386.007.627.0 1.599-.074 1.599-.074.323-.018.361.444.038.482.0.0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304.0 01-.629-.055c-.323-.019-.285-.5.038-.482.0.0.991.074 1.58.074.627.0 1.599-.074 1.599-.074.323-.018.362.444.038.482.0.0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806-1.8 5.095a6.148 6.148.0 003.687-.093.52.52.0 01-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601.0.593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697.0 00-.735-2.803zM8 0a8 8 0 100 16A8 8 0 008 0zm0 15A7 7 0 118 1a7 7 0 010 14z"/></g></symbol><symbol id="icon-youtube" viewBox="0 0 16 16"><g><path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359.0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/></g></symbol></svg><header class=l-header><p class="c-title p-title"><a href=https://dwmkerr.com/ class=p-title__link>dwmkerr.com</a></p><p class=p-subtitle>Articles on the craft of software development. No ads, no sponsored content.</p></header><main id=main class=l-main><article class=p-article><header><h1>Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework</h1><div><div class=c-time>Posted on
<time datetime=2021-04-23T00:00:00Z>Apr 23, 2021</time></div><a href=https://dwmkerr.com/tags/aws class=c-tag>aws</a>
<a href=https://dwmkerr.com/tags/serverless class=c-tag>serverless</a>
<a href=https://dwmkerr.com/tags/cloud class=c-tag>cloud</a>
<a href=https://dwmkerr.com/tags/devsecops class=c-tag>devsecops</a>
<a href=https://dwmkerr.com/tags/codeproject class=c-tag>CodeProject</a></div></header><section id=js-article class=p-article__body><p>In this article I'm going to give a brief overview of some techniques to build &lsquo;least privilege&rsquo; roles in AWS. This assumes a basic knowledge of AWS and Identity and Access Management. It uses the (at time of writing) <a href=https://aws.amazon.com/about-aws/whats-new/2021/04/iam-access-analyzer-easier-implement-least-privilege-permissions-generating-iam-policies-access-activity/>newly announced features in the AWS IAM Access Analyser</a></p><p>I'll be demoing the techniques using a project built on <a href=https://www.serverless.com/>The Serverless Framework</a> but you don't need to know anything about how this framework works to follow the article - it is just used to demonstrate the concepts. You should be able to apply these techniques to almost any process which accesses or manages AWS resources.</p><p>Let's get into it!</p><hr><h2 id=updates-to-the-aws-iam-access-analyser>Updates to the AWS IAM Access Analyser</h2><p>AWS recently announced some new features to the IAM Access Analyser, which are designed to help build &lsquo;least privilege&rsquo; policies for your AWS solutions. As I have been deploying a number of solutions based on <a href=https://www.serverless.com/>The Serverless Application Framework</a> I thought this would be a great time to try out these new features.</p><p>The Serverless Application Framework is a useful framework if you want to rapidly create serverless applications. You can rapidly create lambda functions, deploy to AWS, test locally, debug and so on.</p><h2 id=our-use-case---a-serverless-framework-deployment-process>Our Use Case - A Serverless Framework Deployment Process</h2><p>When you use the Serverless Framework, a common pattern for deployment is to let the framework itself deploy resources.</p><p>A deploy command would look like this:</p><pre><code>serverless deploy --stack uat
</code></pre><p>Under the hood, this will do a few things:</p><ol><li>Create a CloudFormation template which defines an application stack</li><li>Upload the template to an S3 bucket on a specified AWS account</li><li>Deploy the stack</li></ol><p>Now what is deployed is very dependent on what you decide to use in your application, but common resources would be things like:</p><ul><li>CloudFormation Stacks</li><li>Lambda Functions</li><li>API Gateway resources</li><li>DynamoDB tables</li><li>SQS Queues</li><li>&mldr;and many more!</li></ul><p>This raises some interesting questions - how should we secure this provisioning process?</p><h2 id=fundamental-principles---isolation-and-least-privilege>Fundamental Principles - Isolation and Least-Privilege</h2><p>There are two fundamental principles<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> which make sense to consider when thinking about how to integrate the Serverless Framework into your stack:</p><ol><li><strong>Isolation of Resources</strong>: Can we make sure that the stack resources are logically isolated from <em>other</em> resources we are managing? This can reduce the impact of incidents - if the stack is compromised, it should only compromise specific resources, not all resources in your estate</li><li><strong>Least Privilege</strong>: Can we make sure that when the <code>serverless</code> binary deploys resources, it has the least permissions required to do its work, again reducing the impact of a potential incident</li></ol><p>Isolation of resources can be handled in a number of ways - my preferred approach is to create separate AWS accounts for each application (and in fact, each environment, such as &lsquo;dev&rsquo;, &lsquo;test&rsquo; and so on). This is not something I will discuss in this article. What I would like to focus on is the second point - least privilege.</p><h2 id=least-privilege-in-aws>Least Privilege in AWS</h2><p>We don't quite know what the Serverless Framework does when it provisions resources. I don't mean this in a bad way. We <em>could</em> investigate and read in detail exactly what happens, but part of the benefit of the framework is that it takes care of this for you. In the early stages of a project this is probably a great time saver - in the later stages it represents a potential vulnerability.</p><p>We understand that it creates a CloudFormation stack, but some of the details are not necessarily readily discoverable from the documentation.</p><p>If we wanted to create a policy which represents the permissions which the Serverless we could try a few approaches:</p><ul><li>Give the process full access to an environment, with wide permissions to create any resources</li><li>Give the process limited access to an environment, run the provisioning process, see the permissions issues which arise, then iteratively add more permissions</li></ul><p>You might think that the first instinct of a security team might be that a &lsquo;full access&rsquo; approach is fundamentally wrong. But great security experts balance risk, agility, cost all the time. They don't want to stop experimentation - just make sure that it is done in a safe way.</p><p>The first approach is perfectly fine in low sensitivity environments. If you want to move fast and try out the technology, you could lose valuable time trying to get the permissions just right. If you have a solid approach to <em>isolation</em>, then you should be able to run your proof of concepts in an isolated sandbox environment, which has no access to sensitive resources.</p><p>You can also add Billing Alerts, or even automate the <em>destruction</em> of resources at a certain point, so that you automatically &lsquo;clean up&rsquo;. This is great security practice - provide teams with a way to experiment <em>safely</em>. Give teams full access to their own self-serve sandbox environments, with automated guardrails to mitigate the risk of incidents<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><h2 id=beyond-the-sandbox>Beyond the Sandbox</h2><p>The &lsquo;sandbox environment&rsquo; approach <em>can</em> be valid. But there will likely come a stage when this is no longer appropriate.</p><p>When you want to deploy into an environment which has other resources, sensitive data, is accessible to the public, runs production workloads and so on. There will likely come a point where you cannot fully isolate your application - at this stage we should be looking at improving our security.</p><p>Specifically, at this point we really should try to make sure that we limit the permissions of the process which runs the <code>serverless deploy</code> command.</p><p>Limiting the permissions has the benefit of reducing the &lsquo;blast radius&rsquo; of an attack. If the process is compromised it can do fewer things. It also has the benefit of <em>increasing transparency</em> - we will explicitly document <em>what we expect the process to do</em>. This is highly useful when performing security checks.</p><h2 id=the-challenges-of-limiting-permissions>The Challenges of Limiting Permissions</h2><p>The process of working out the specific permissions required for a process can be challenging. It might involve looking through lots of documentation, trying to build a policy, seeing if the process works, adding permissions, changing permissions and so on.</p><p>Just this month AWS released some updates to the IAM Access Manager, adding some features to help build &lsquo;least permission&rsquo; policies:</p><p><a href=https://aws.amazon.com/about-aws/whats-new/2021/04/iam-access-analyzer-easier-implement-least-privilege-permissions-generating-iam-policies-access-activity/>https://aws.amazon.com/about-aws/whats-new/2021/04/iam-access-analyzer-easier-implement-least-privilege-permissions-generating-iam-policies-access-activity/</a></p><p>These features immediately caught my eye as I'm very interesting in security practices. We're going to take a look at these features in detail for the rest of the article and see how we can use them to improve the security of a process like our &lsquo;serverless deployment&rsquo;.</p><h2 id=using-the-iam-access-analyser-to-build-fine-grained-policies>Using the IAM Access Analyser to Build Fine-Grained Policies</h2><p>The process for generating fine grained policies with the IAM Access Analyser is quite simple:</p><ol><li>Ensure you are using CloudTrail to track access to resources</li><li>Create an Access Analyser</li><li>Run the process you want to create fine-grained permissions for, initially with wide permissions</li><li>Use the Access Analyser to generate a policy based on the events in CloudTrail</li><li>Refine the policy</li><li>Document, document, document</li></ol><p>I'm going to demonstrate this end-to-end with a &lsquo;serverless framework deployment&rsquo; process. Please keep an eye out for an article I'll be writing soon on how to build a REST application with the Serverless Framework - for now don't worry about the application itself too much, this could be any kind of deployment or operational process we're running.</p><h3 id=step-1-enable-cloudtrail>Step 1: Enable CloudTrail</h3><p>We need to enable CloudTrail so that we have a log of API calls which Access Advisor can analyse.</p><p><strong>Warning</strong>: if you trying these features out please be aware that they may fall outside of the <a href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&all-free-tier.sort-order=asc&awsf.Free%20Tier%20Types=*all&awsf.Free%20Tier%20Categories=*all">AWS Free Tier</a> and so may incur a cost. Please be aware of this if you are testing these features.</p><p>Open the CloudTrail portal and ensure that you have a trail setup which logs API calls. Once this is setup you should see something like this:</p><img src=./images/cloudtrail.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/cloudtrail.png" class=img-zoomable><p>You can use the code below as an example of how to create a trail:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>aws cloudtrail create-trail <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --name management-events <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --s3-bucket-name cloudtrail-account123-management-events-bucket <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --is-multi-region-trail
</code></pre></div><p>Note that if you don't use the <code>--is-multi-region-trail</code> flag then the trail is created for the current region only.</p><p>You can read more about this command on the <a href=https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-and-update-a-trail-by-using-the-aws-cli-create-trail.html>Using create-trail</a> documentation page.</p><h3 id=step-2-create-the-access-analyser>Step 2: Create the Access Analyser</h3><p>You should be able to find the Access Analyser tool in the IAM page:</p><img src=./images/access-analyser.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/access-analyser.png" class=img-zoomable><p>You can now choose to create an analyser. Some things to note:</p><ul><li>Analysers are region specific - if you have many regions, you need many analysers</li><li>You can provide a name, not surprising, but it might be useful to be highly descriptive here</li><li>You have an option to specify the &lsquo;zone of trust&rsquo; - this might be an account or an entire organisation</li></ul><p>Choose &lsquo;Create Analyser&rsquo; to create the access analyser.</p><p>You'll shortly see the created access analyser and likely some &lsquo;findings&rsquo; as well:</p><img src=./images/access-analyser-created.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/access-analyser-created.png" class=img-zoomable><p>&lsquo;Findings&rsquo; are the descriptions of the policies that grant access to a resource to a principal which is <em>outside of your zone of trust</em>. This is a quite complex topic, there are more details on the <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/access-analyzer-findings.html>Access Analyser findings</a> documentation. But we are essentially seeing that my policies are set up in a which is exposing my resources to principals outside of the defined zone of trust - these findings are entirely correct, as I have set up <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html>Cross Account Access</a> in this environment.</p><p>Feel free to read more about findings - these findings can potentially be very useful for a security team to be aware. For now we'll leave these findings alone and move onto the next step in creating fine grained policies, which is to run the process we want to secure.</p><h3 id=step-3-run-your-process>Step 3: Run your process</h3><p>Now you should run the process you want to create fine grained permissions for. To save rework, try and make sure you run <em>all</em> part of the process which will be needed. For example, my Serverless Framework policy should cover creation of the stack, updating of the stack as well as deleting.</p><p>To exercise this, I just need to run the following commands from my local project:</p><pre><code># This command deploys a new stack...
serverless --stage dev deploy

# This command makes a change to a file, allowing us to update the stack...
echo &quot;// testing a change to the stack...&quot; &gt;&gt;&gt; lambda_functions/my_function.js
serverless --stage dev deploy # this will update the stack

# This command deletes the stack, we then reset the changes to the file.
serverless --stage dev remove # this will destroy the stack
git checkout lambda_functions/my_function.js
</code></pre><p>At this point you can run any process your want to secure. As CloudTrail is enable, API calls will be recorded.</p><h3 id=step-4-create-a-policy-based-on-access-advisor>Step 4: Create a Policy based on Access Advisor</h3><p>Now we get to the interesting part. Open the Roles view in AWS, select the role which is used when running your process and choose &lsquo;Generate Policy&rsquo;. Here's how this will look in the portal:</p><img src=./images/generate-policy.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/generate-policy.png" class=img-zoomable><p>Note that this screenshot shows <em>exactly why</em> fine grained permissions are so important. I have run the Serverless Framework deployment from my local machine using the &lsquo;Cross Account Administrator&rsquo; role. This is an extremely high-privilege role which is used when I administer AWS accounts which are part of my organisation. This is <em>not</em> an appropriate role for the Serverless Framework binary to assume outside of a sandbox or proof of concept context. However - remember at this stage we want to use a high-privilege role so that the process runs to completion, so that we can see the permissions needed and then create a more refined role.</p><p>When you choose to generate a policy, you'll have the option of specifying which trail to use and which region. You can also choose a date range for events to analyse. It will be a lot easier to build an appropriate policy if you make this window as short as possible - so try and run the entire process you want to create a policy for and then immediately generate the policy.</p><p>It can take a few minutes to generate the policy. When it is complete, you'll see the option to view the generated policy:</p><img src=./images/view-generated-policy.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/view-generated-policy.png" class=img-zoomable><p>Opening it up, you'll see the services and actions used, as well as options to add more actions:</p><img src=./images/generated-policy.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/generated-policy.png" class=img-zoomable><p>When you move to the next screen you'll get the option to customise the permissions:</p><img src=./images/customise-permissions.png alt="Building Least Privilege Policies with the AWS Policy Advisor - and a Demo with the Serverless Application Framework ./images/customise-permissions.png" class=img-zoomable><p>At this stage I would suggest copying the policy, saving it to a local file and then moving onto the next step - refining the policy.</p><h3 id=step-5-refine-the-policy>Step 5: Refine the Policy</h3><p>The generated policy will likely not be suitable for use yet. It might to too specific - limiting access to the specific resources which were used. You will also have services and actions listed for <em>any</em> calls which have been made using the role - which might also include calls used for <em>other</em> processes than just the one you tested earlier. For example, my policy has some permissions to list analyzers. That is <em>not</em> needed by serverless - that has been included because I was using the same cross-account administrator role to create the analyzer earlier on, and this has been picked up.</p><p>This also highlights the importance of using separate roles for separate processes - if you use a small number of roles to do a lot of different things, it can be very hard to understand why certain actions were taken. Again, for a quick test it might be OK to use the same role that you access the portal with, but it is good to get into the habit of quickly creating roles for specific purposes.</p><p>This is where I would suggest going through the policy in detail and using it as a template for the &lsquo;final&rsquo; policy. This is what we'll discus in the final step.</p><h3 id=step-6-document-document-document>Step 6: Document, Document, Document</h3><p>The final policy we create should be clearly documented. It is really important to explain <em>why</em> certain permissions are needed. If people cannot reason about why a policy is set up in a specific way, then it will be very hard for them to maintain it over time or decide whether the permissions are appropriate or not.</p><p>Even more so than with &lsquo;normal&rsquo; code, code which relates to security has to be comprehensible by others (or yourself when you come back to it). If you cannot understand why a policy grants a certain permission, then when you review the policy you don't know whether the remove the permissions or leave them in (this is an example of <a href=https://github.com/dwmkerr/hacker-laws#chestertons-fence>Chesterton's Fence</a>.</p><p>Whether you document this policy by saving it in a file, adding comments and checking it into source control, or turning it into a re-usable Terraform module, or using Pulimi to define the policy, or some other solution, is not too important. What <em>is</em> important is documenting the policy and making this documentation transparent to others - and ideally making sure that others can maintain it over time.</p><p>As an example, this is how I might define the S3 permissions in a Terraform file:</p><pre><code># This statement allows the creation and management of buckets, which are used
# by serverless for CloudFormation files. Because the bucket name is
# non-deterministic we have to allow the creation of _any_ bucket.
statement {
  sid       = &quot;ServerlessFrameworkS3&quot;
  effect    = &quot;Allow&quot;
  actions = [
    &quot;s3:CreateBucket&quot;,
    &quot;s3:DeleteBucket&quot;,
    &quot;s3:DeleteBucketPolicy&quot;,
    &quot;s3:GetBucketAcl&quot;,
    &quot;s3:GetBucketPolicy&quot;,
    &quot;s3:GetBucketPolicyStatus&quot;,
    &quot;s3:GetBucketPublicAccessBlock&quot;,
    &quot;s3:GetEncryptionConfiguration&quot;,
    &quot;s3:GetObject&quot;,
    &quot;s3:ListBucket&quot;,
    &quot;s3:PutBucketPolicy&quot;,
    &quot;s3:PutBucketPublicAccessBlock&quot;,
    &quot;s3:PutBucketTagging&quot;,
    &quot;s3:PutEncryptionConfiguration&quot;,
    &quot;s3:PutObject&quot;,
    &quot;s3:SetBucketEncryption&quot;,
  ]
  resources = [
    &quot;arn:aws:s3:::*&quot;
  ]
}
</code></pre><p>I'm being very explicit with my comments, giving the statement id a meaningful value and creating separate statements for <em>each service</em>.</p><p>How you structure your policies will depend on the tools you use and your own preferred processes but the principle will remain the same - document carefully!</p><h2 id=thats-it>That's It!</h2><p>The IAM Access Advisor is a powerful feature and should be of interest to anyone managing sensitive environments in the cloud.</p><p>It is not limited to creating fine grained permissions - it can also help identify <em>external access</em> to resources. This means it can be used to identify when resources such as S3 buckets are accessed via processes such as Cross-Account access.</p><p>There are a lot of exciting features here and it will be interesting to see how the Access Advisor works over time!</p><p>As usual, please do share any comments, suggestions or observations!</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Of course this is only a tiny part of the world of security best practices. To learn more I highly recommend <a href=https://github.com/veeral-patel/how-to-secure-anything>Veeral Patel's amazing &lsquo;How to secure anything&rsquo; project</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>This is a great way to get engineers to think more about security - let them experiment with it and learn about it safely. Sandbox environments <em>still</em> need certain protections. For example, you don't want someone to inadvertently install a component which spins up a bunch of EC2 instances which start bitcoin mining, but AWS has a raft of features to help you build these kinds of guardrails, without limiting the ability of engineers to test and learn. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></section><footer><div id=disqus_thread></div><script>var disqus_shortname='dwmkerr';(function(){var d=document,s=d.createElement('script');s.src='https://'+disqus_shortname+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><nav class="p-pagination c-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer></div><div class=c-pagination__older><a href=https://dwmkerr.com/unit-testing-the-windows-registry/>Older</a></div></div></nav><section class=p-related><h3>See Also</h3><ul id=slider class=p-related__list><li class="p-related__item js-related__item"><a href=/unit-testing-the-windows-registry/><span>Unit Testing the Windows Registry</span></a></li><li class="p-related__item js-related__item"><a href=/modernising-dotnet-projects/><span>Modernising .NET projects for .NET Core and beyond!</span></a></li><li class="p-related__item js-related__item"><a href=/tips-for-cka/><span>Observations, tips and tricks for the CKA certification</span></a></li><li class="p-related__item js-related__item"><a href=/conventional-commits-and-semantic-versioning-for-java/><span>Supercharge your Java Projects with Conventional Commits, Semantic Versioning and Semantic Releases</span></a></li><li class="p-related__item js-related__item"><a href=/effective-shell-for-beginners/><span>Effective Shell for Beginners</span></a></li><li class="p-related__item js-related__item"><a href=/effective-shell-7-shell-commands/><span>Effective Shell Part 7: The Subtleties of Shell Commands</span></a></li></ul></section><aside class=p-author><div class="c-avatar p-author__avatar"><img alt="Author Avatar" src=/images/avatar.jpeg></div><div class=p-author__body><p class="c-title p-author__name">Dave Kerr</p><p>Climber, Coder, Technology Consultant. Views expressed are my own.</p></div></aside></footer></article></main><nav class="l-nav p-menu"><ul class=p-menu__lists><li class=p-menu__listitem><a href=/>Blog</a></li><li class=p-menu__listitem><a href=/page/speaking/>Speaking</a></li><li class=p-menu__listitem><a href=/page/about/>About</a></li></ul></nav><footer class=l-footer><ul class=c-links><li class=c-links__item><a href=https://twitter.com/dwmkerr target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>twitter</title><use xlink:href="#icon-twitter"/></svg></a></li><li class=c-links__item><a href=https://github.com/dwmkerr target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>github</title><use xlink:href="#icon-github"/></svg></a></li><li class=c-links__item><a href=https://www.npmjs.com/dwmkerr target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>npm</title><use xlink:href="#icon-npm"/></svg></a></li><li class=c-links__item><a href=https://linkedin.com/in/dwmkerr target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>linkedin</title><use xlink:href="#icon-linkedin"/></svg></a></li></ul><p class=p-copyright>Copright &copy; Dave Kerr</p></footer></body></html>