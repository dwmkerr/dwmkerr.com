<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Patching Kubernetes Resources in Golang &#183; Dave Kerr</title><meta name=description content="Recently I needed to be able to quickly adjust the number of replicas in a Kubernetes Replication Controller. The original solution I'd seen pulled down the spec, modified it, then updated it. There's a better way!
There's a patch API for Kubernetes resources. Patching resources is faster and easier than pulling them and updating the spec wholesale. However, the documentation is a little limited.
After some trial and error I got it working, here's the solution."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.61.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Patching Kubernetes Resources in Golang"><meta property="og:description" content="Recently I needed to be able to quickly adjust the number of replicas in a Kubernetes Replication Controller. The original solution I'd seen pulled down the spec, modified it, then updated it. There's a better way!
There's a patch API for Kubernetes resources. Patching resources is faster and easier than pulling them and updating the spec wholesale. However, the documentation is a little limited.
After some trial and error I got it working, here's the solution."><meta property="og:type" content="article"><meta property="og:url" content="https://dwmkerr.github.io/dwmkerr.com/patching-kubernetes-resources-in-golang/"><link rel=stylesheet href=https://dwmkerr.github.io/dwmkerr.com/dist/styles.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-41728580-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=dwmkerr.com href=https://dwmkerr.github.io/dwmkerr.com/>dwmkerr.com</a></h1><a class=button-square href=https://dwmkerr.github.io/dwmkerr.com/index.xml><i class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/dwmkerr rel=me><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/dwmkerr rel=me><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/1189164/dave-kerr rel=me><i class="fa fa-stack-overflow"></i></a><a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/dwmkerr/ rel=me><i class="fa fa-linkedin"></i></a></div><ul class=site-nav><li class=site-nav-item><a title=Blog href=/dwmkerr.com/>Blog</a></li><li class=site-nav-item><a title=Speaking href=/dwmkerr.com/page/speaking/>Speaking</a></li><li class=site-nav-item><a title=About href=/dwmkerr.com/page/about/>About</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Patching Kubernetes Resources in Golang</h1><p class="post-date post-line"><span>Published <time datetime=2018-07-24 itemprop=datePublished>Tue, Jul 24, 2018</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/dwmkerr itemprop=url rel=author>Dave Kerr</a></span></span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=/images/2018/07/patch.jpg><p>Recently I needed to be able to quickly adjust the number of replicas in a Kubernetes Replication Controller. The original solution I'd seen pulled down the spec, modified it, then updated it. There's a better way!</p><p><img src=images/patch-1.jpg alt="Kuberentes Patch API"></p><p>There's a <a href=https://kubernetes.io/docs/tasks/run-application/update-api-object-kubectl-patch/>patch API for Kubernetes resources</a>. Patching resources is faster and easier than pulling them and updating the spec wholesale. However, the documentation is a little limited.</p><p>After some trial and error I got it working, here's the solution. I thought it might be helpful to share for others!</p><h3 id=the-solution>The Solution</h3><p>I'll start with the solution. If this is all you need, you are good to go. The details of how this works are presented afterwards. In this example I'll update the number of replicas in the <code>my-rc</code> controller:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
	<span style=color:#e6db74>&#34;fmt&#34;</span>

	<span style=color:#a6e22e>types</span> <span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/types&#34;</span>
	<span style=color:#e6db74>&#34;k8s.io/client-go/kubernetes&#34;</span>
	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;k8s.io/client-go/plugin/pkg/client/auth&#34;</span>
	<span style=color:#e6db74>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
)

<span style=color:#66d9ef>var</span> (
	<span style=color:#75715e>//  Leave blank for the default context in your kube config.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>context</span> = <span style=color:#e6db74>&#34;&#34;</span>

	<span style=color:#75715e>//  Name of the replication controller to scale, and the desired number of replicas.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>replicationControllerName</span> = <span style=color:#e6db74>&#34;my-rc&#34;</span>
	<span style=color:#a6e22e>replicas</span>                  = uint32(<span style=color:#ae81ff>3</span>)
)

<span style=color:#75715e>//  patchStringValue specifies a patch operation for a string.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>patchStringValue</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Op</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>json:&#34;op&#34;</span><span style=color:#e6db74>`</span>
	<span style=color:#a6e22e>Path</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>json:&#34;path&#34;</span><span style=color:#e6db74>`</span>
	<span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>json:&#34;value&#34;</span><span style=color:#e6db74>`</span>
}

<span style=color:#75715e>//  patchStringValue specifies a patch operation for a uint32.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>patchUInt32Value</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Op</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>json:&#34;op&#34;</span><span style=color:#e6db74>`</span>
	<span style=color:#a6e22e>Path</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>json:&#34;path&#34;</span><span style=color:#e6db74>`</span>
	<span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>uint32</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>json:&#34;value&#34;</span><span style=color:#e6db74>`</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>scaleReplicationController</span>(<span style=color:#a6e22e>clientSet</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>Clientset</span>, <span style=color:#a6e22e>replicasetName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>scale</span> <span style=color:#66d9ef>uint32</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>payload</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>patchUInt32Value</span>{{
		<span style=color:#a6e22e>Op</span>:    <span style=color:#e6db74>&#34;replace&#34;</span>,
		<span style=color:#a6e22e>Path</span>:  <span style=color:#e6db74>&#34;/spec/replicas&#34;</span>,
		<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>scale</span>,
	}}
	<span style=color:#a6e22e>payloadBytes</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>payload</span>)
	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientSet</span>.
		<span style=color:#a6e22e>CoreV1</span>().
		<span style=color:#a6e22e>ReplicationControllers</span>(<span style=color:#e6db74>&#34;default&#34;</span>).
		<span style=color:#a6e22e>Patch</span>(<span style=color:#a6e22e>replicasetName</span>, <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>JSONPatchType</span>, <span style=color:#a6e22e>payloadBytes</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#75715e>//  Get the local kube config.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Connecting to Kubernetes Context %v\n&#34;</span>, <span style=color:#a6e22e>context</span>)
	<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>NewNonInteractiveDeferredLoadingClientConfig</span>(
		<span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>NewDefaultClientConfigLoadingRules</span>(),
		<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>clientcmd</span>.<span style=color:#a6e22e>ConfigOverrides</span>{<span style=color:#a6e22e>CurrentContext</span>: <span style=color:#a6e22e>context</span>}).<span style=color:#a6e22e>ClientConfig</span>()
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
	}

	<span style=color:#75715e>// Creates the clientset
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>clientset</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>NewForConfig</span>(<span style=color:#a6e22e>config</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
	}

	<span style=color:#75715e>//  Scale our replication controller.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Scaling replication controller %v to %v\n&#34;</span>, <span style=color:#a6e22e>replicationControllerName</span>, <span style=color:#a6e22e>replicas</span>)
	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>scaleReplicationController</span>(<span style=color:#a6e22e>clientset</span>, <span style=color:#a6e22e>replicationControllerName</span>, <span style=color:#a6e22e>replicas</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
	}
}
</code></pre></div><p>This code is also available in the <a href=https://gist.github.com/dwmkerr/447692c8bba28929ef914239781c4e59>k8s-patch.go</a> gist.</p><h3 id=the-mechanism>The Mechanism</h3><p>The Kubernetes Patch API supports a few different methods for modifying resources. It is important to be aware that there is not a universally accepted &lsquo;standard&rsquo; approach to representing a <em>change</em> to a resource in a REST API.</p><p>There are three strategies you can use to patch:</p><ol><li><code>merge</code>: follows the <a href=https://tools.ietf.org/html/rfc7386>JSON Merge Patch Spec (RFC 7386)</a></li><li><code>stragetic</code>: A strategic merge, which addresses some limitations of the merge patch (noted in <a href=%5Bdocs/devel/api-conventions.md#patch-operations%5D(https://github.com/kubernetes/kubernetes/blob/release-1.1/docs/devel/api-conventions.md#patch-operations)>this doc</a>.</li><li><code>json</code>: follows the <a href=https://tools.ietf.org/html/rfc6902>JSON Patch Spec (RFC 6902)</a></li></ol><p>These are documented in detail at:</p><p><a href=https://github.com/kubernetes/kubernetes/blob/release-1.1/docs/devel/api-conventions.md#patch-operations>docs/devel/api-conventions.md#patch-operations</a></p><p>The mechanism I've used here is <code>json</code>, which I think is the clearest to the reader. To use this strategy we need to build a payload describing what we are changing. This might look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;op&#34;</span>: <span style=color:#e6db74>&#34;replace&#34;</span>,
    <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/spec/replicas&#34;</span>,
    <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>4</span>
}
</code></pre></div><p>The <code>op</code> field can be <code>remove</code>, <code>replace</code>, <code>add</code> etc etc (all the details are in the <a href=https://tools.ietf.org/html/rfc6902>RFC 6902)</a>, or the slightly more readable <a href=jsonpatch.com>jsonpatch.com</a>). This allows the operation to be very <em>explicit</em> to the reader, which is helpful. We create a struct which represents an operation on a string or integer (or whatever data type we need), serialize it and pass to the API.</p><p>Under the hood, the Golang client will simply translate this into an HTTP call which will look like something like this:</p><pre><code>PATCH /api/v1/namespaces/default/replicationcontrollers/app-server-blue HTTP/1.1
Host: 127.0.0.1
Content-Type: application/json-patch+json
Content-Length: 70

[{
	&quot;op&quot;: &quot;replace&quot;,
  	&quot;path&quot;: &quot;/spec/replicas&quot;,
  	&quot;value&quot;: 4
}]
</code></pre><p>This corresponds to the documentation on the <a href=https://github.com/kubernetes/kubernetes/blob/release-1.1/docs/devel/api-conventions.md#patch-operations>Patch Operations</a>. Note that the patch operation type is specified in the <code>Content-Type</code> header.</p><p>Hopefully this'll help you if you need to patch resources, are struggling with the docs and are a Go noob like me! Any tips on how to make the code cleaner or more idomatic would be welcome.</p><p>Thanks to the following articles and issues which helped me unpick this:</p><ul><li><a href=https://stackoverflow.com/questions/43415728/kubernetes-go-client-patch-example>Stack Overflow: Kubernetes Go Client Patch Example</a></li><li><a href=https://kubernetes.io/docs/tasks/run-application/update-api-object-kubectl-patch/>Kubernetes Docs: Update API Objects in Place Using kubectl patch</a></li><li><a href=https://github.com/kubernetes/kubernetes/blob/release-1.1/docs/devel/api-conventions.md#patch-operations>Kubernetes Docs: Patch Operations</a></li></ul></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/dwmkerr.com/tags/Kubernetes/>Kubernetes</a>,
<a href=/dwmkerr.com/tags/Golang/>Golang</a>,
<a href=/dwmkerr.com/tags/Devops/>Devops</a>,
<a href=/dwmkerr.com/tags/Docker/>Docker</a>,
<a href=/dwmkerr.com/tags/CodeProject/>CodeProject</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Patching%20Kubernetes%20Resources%20in%20Golang&url=https%3a%2f%2fdwmkerr.github.io%2fdwmkerr.com%2fpatching-kubernetes-resources-in-golang%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdwmkerr.github.io%2fdwmkerr.com%2fpatching-kubernetes-resources-in-golang%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dmwkerr"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=dwmkerr.com href=https://dwmkerr.github.io/dwmkerr.com/>dwmkerr.com</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2019 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=https://dwmkerr.github.io/dwmkerr.com/js/jquery-1.11.3.min.js></script><script src=https://dwmkerr.github.io/dwmkerr.com/js/jquery.fitvids.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://dwmkerr.github.io/dwmkerr.com/js/scripts.js></script></body></html>