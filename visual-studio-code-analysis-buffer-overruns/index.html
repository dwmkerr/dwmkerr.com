<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Visual Studio Code Analysis - Buffer Overruns &#183; Dave Kerr</title><meta name=description content="Today I was looking through some fairly old source code in a large solution, large in this case is ~300 projects and about 1 million lines of code. Parts of the code base are very old - at some stage a decision was made to disable warning C4996. The problem I came across is reduced to its most simple form below:
// AnalysisExample.cpp : An example of how static analysis can help."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.61.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Visual Studio Code Analysis - Buffer Overruns"><meta property="og:description" content="Today I was looking through some fairly old source code in a large solution, large in this case is ~300 projects and about 1 million lines of code. Parts of the code base are very old - at some stage a decision was made to disable warning C4996. The problem I came across is reduced to its most simple form below:
// AnalysisExample.cpp : An example of how static analysis can help."><meta property="og:type" content="article"><meta property="og:url" content="https://dwmkerr.github.io/dwmkerr.com/visual-studio-code-analysis-buffer-overruns/"><link rel=stylesheet href=https://dwmkerr.github.io/dwmkerr.com/dist/styles.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-41728580-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=dwmkerr.com href=https://dwmkerr.github.io/dwmkerr.com/>dwmkerr.com</a></h1><a class=button-square href=https://dwmkerr.github.io/dwmkerr.com/index.xml><i class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/dwmkerr rel=me><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/dwmkerr rel=me><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/1189164/dave-kerr rel=me><i class="fa fa-stack-overflow"></i></a><a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/dwmkerr/ rel=me><i class="fa fa-linkedin"></i></a></div><ul class=site-nav><li class=site-nav-item><a title=Blog href=/dwmkerr.com/>Blog</a></li><li class=site-nav-item><a title=Speaking href=/dwmkerr.com/page/speaking/>Speaking</a></li><li class=site-nav-item><a title=About href=/dwmkerr.com/page/about/>About</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Visual Studio Code Analysis - Buffer Overruns</h1><p class="post-date post-line"><span>Published <time datetime=2011-09-20 itemprop=datePublished>Tue, Sep 20, 2011</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/dwmkerr itemprop=url rel=author>Dave Kerr</a></span></span></p></header><div class="post-content clearfix" itemprop=articleBody><p>Today I was looking through some fairly old source code in a large solution, large in this case is ~300 projects and about 1 million lines of code. Parts of the code base are very old - at some stage a decision was made to disable warning C4996. The problem I came across is reduced to its most simple form below:</p><pre class="brush: c-sharp;">// AnalysisExample.cpp : An example of how static analysis can help.
//
<p>#include &ldquo;stdafx.h&rdquo;</p>
<p>int _tmain(int argc, _TCHAR* argv[])
{
//	Create two buffers, one small, one large.
TCHAR storageSmall[13];
TCHAR storageLarge[128];</p>
<pre><code>//	Get a pointer to a string literal.
TCHAR* str = _T(&quot;Here is a string that is too long.&quot;);

//	Now do something very dangerous.
::_tcscpy(storageLarge, str);
::_tcscpy(storageSmall, storageLarge);

return 0;
</code></pre><p>}</pre></p><p>Now in a sensible world with this warning enabled, we would get the following when compiling:</p><pre>analysisexample.cpp(14): warning C4996: 'wcscpy': 
This function or variable may be unsafe. Consider using 
wcscpy_s instead. To disable deprecation, use 
_CRT_SECURE_NO_WARNINGS. See online help for details.</pre><pre>analysisexample.cpp(15): warning C4996: 'wcscpy': 
This function or variable may be unsafe. Consider using 
wcscpy_s instead. To disable deprecation, use 
_CRT_SECURE_NO_WARNINGS. See online help for details.</pre><p>The warning is telling us that wcscpy (which is what _tcscpy translates to in a Unicode build) is unsafe, which indeed it is as it does no buffer checking. However, when you migrate a Visual Studio 2005 solution to 2008 or straight to 2010 then suddenly you'll get lots of warnings like this. If there are thousands of warnings and they're masking other more important ones then you can see why maybe you'd consider disabling them.</p><p>Why is this a bug?</p><p>In case you didn't see it, a string literal that is 34 characters long (68 bytes) is copied to a buffer 128 characters long. OK so far. Then we copy the 34 characters into a smaller 13 character buffer - this causes a buffer overrun on the stack. In reality what happens is variables used subsequently in the function get overwritten unexpectedly. Or don't. Generally the worst case is that nothing odd happens during testing, but then the code blows up on-site with the customer, typically on something business critical like a database server - something it's hard to debug on.</p><p>Visual Studio's Code Analysis tool is a life-saver. If you haven't used it before, get used to running it on <em>all</em>&nbsp;of your projects. Here's what happens when we run it (Analyze > Run Code Analysis On Solution):</p><pre>1&gt;analysisexample.cpp(18): warning C6202: 
Buffer overrun for 'storageSmall', which is possibly 
stack allocated, in call to 'wcscpy': length '256' 
exceeds buffer size '26'</pre><p>Code analysis has shown us <em>exactly</em>&nbsp;the problem, even with the warning disabled.</p><p>So why is this important? Imagine we have the following four lines spread across four files:</p><pre class="brush: c-sharp;">//	Defined in Header1.h
static const int LENGTH1 = 13;
<p>//	Defined in Header2.h
static const int LENGTH2 = 128;</p>
<p>//	Defined in Header3.h
typedef TCHAR LineOne[LENGTH1];</p>
<p>//	Defined in Header4.h
typedef TCHAR LineTwo[LENGTH2];</pre></p><p>Our code could now look like this:</p><pre class="brush: c-sharp;">//	Create two buffers, one small, one large.
LineOne storageSmall;
LineTwo storageLarge;
<p>//	Get a pointer to a string literal.
TCHAR* str = _T(&ldquo;Here is a string that is too long.&quot;);</p>
<p>//	Now do something very dangerous.
::_tcscpy(storageLarge, str);
::_tcscpy(storageSmall, storageLarge);</pre></p><p>Suddenly things aren't looking quite so obviously wrong - now imagine the different lines that make up this bug are spread across more files - or even more projects. Static analysis takes only a few seconds to run, unfortunately it's only available in the more expensive versions of visual studio.</p><p>An even better solution - don't run the risk, use <strong>_tcscpy_s</strong>&nbsp;rather than <strong>_tcscpy </strong>- it checks the buffer length without even requiring a single extra parameter in the example above.</p></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/dwmkerr.com/tags/Debugging/>Debugging</a>,
<a href=/dwmkerr.com/tags/Code-Analysis/>Code Analysis</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Visual%20Studio%20Code%20Analysis%20-%20Buffer%20Overruns&url=https%3a%2f%2fdwmkerr.github.io%2fdwmkerr.com%2fvisual-studio-code-analysis-buffer-overruns%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdwmkerr.github.io%2fdwmkerr.com%2fvisual-studio-code-analysis-buffer-overruns%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dmwkerr"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=dwmkerr.com href=https://dwmkerr.github.io/dwmkerr.com/>dwmkerr.com</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2019 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=https://dwmkerr.github.io/dwmkerr.com/js/jquery-1.11.3.min.js></script><script src=https://dwmkerr.github.io/dwmkerr.com/js/jquery.fitvids.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://dwmkerr.github.io/dwmkerr.com/js/scripts.js></script></body></html>