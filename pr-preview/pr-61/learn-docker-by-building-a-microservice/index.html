<!doctype html><html lang=en-uk prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Learn Docker by building a Microservice</title><meta property="og:title" content="Learn Docker by building a Microservice"><meta name=twitter:title content="Learn Docker by building a Microservice"><meta name=description content="Articles on the craft of software development."><meta property="og:description" content="Articles on the craft of software development."><meta name=twitter:description content="Articles on the craft of software development."><meta name=author content="Dave Kerr"><meta property="og:site_name" content="dwmkerr.com"><meta property="og:url" content="https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/learn-docker-by-building-a-microservice/"><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.154.5"><script async src="https://www.googletagmanager.com/gtag/js?id=G-XNRSGLYJRM"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XNRSGLYJRM")}</script><link rel=stylesheet href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/css/style.css><link rel=stylesheet href=https://dwmkerr.github.io/css/custom.css><link rel=icon type=image/x-icon href=https://dwmkerr.github.io/images/favicon.ico></head><body><a href=#main class="skip-link p-screen-reader-text"></a><svg style="display:none" aria-hidden="true"><symbol id="icon-500px" viewBox="0 0 16 16"><g><path d="M3.953 10.512a5.24 5.24.0 006.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122A5.226 5.226.0 008.912 3.59c-.716.0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491.0-.122.0-.487-.266-.491H4.377a.343.343.0 00-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262.0 013.037-1.25c1.147.0 2.222.444 3.028 1.25a4.245 4.245.0 011.256 3.019 4.236 4.236.0 01-1.25 3.019 4.336 4.336.0 01-3.047 1.25 4.136 4.136.0 01-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09.0 011.588-.716c.594.0 1.15.225 1.566.634.409.406.637.95.637 1.528A2.179 2.179.0 018.887 11.02c-.238.0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173.0 003.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856.0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181.0 00.131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088.0.184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16.0 00-.113-.047c-.078.0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938.0-1.938.191-2.669.506a.207.207.0 00-.134.181.753.753.0 00.069.337c.047.116.166.425.4.334a6.689 6.689.0 012.334-.444 6.35 6.35.0 012.469.497c.622.263 1.206.644 1.844 1.194a.22.22.0 00.147.059c.125.0.244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858.0 00-2.1-1.356 7.326 7.326.0 00-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32.0 01-6.938 1.356 6.336 6.336.0 01-2.013-1.356 6.046 6.046.0 01-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261.0 002.04 3.994 7.266 7.266.0 0010.288.0l.059-.059c.069-.084.134-.225-.159-.516z"/></g></symbol><symbol id="icon-codepen" viewBox="0 0 16 16"><g><path d="M14.777 5.751l-7-4.667a.5.5.0 00-.555.0l-7 4.667a.501.501.0 00-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5.0 00.554.0l7-4.667a.501.501.0 00.223-.416V6.167a.501.501.0 00-.223-.416zM7.5 10.232 4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5 1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2 3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5 14 7.101v2.798L11.901 8.5z"/></g></symbol><symbol id="icon-dribbble" viewBox="0 0 16 16"><g><path d="M8 16c-4.412.0-8-3.588-8-8s3.587-8 8-8c4.412.0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7.0 011.328 4.872 6.845 6.845.0 002.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807.0 006.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04.0 01.269-.081 24.04 24.04.0 00-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209.0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831A43.092 43.092.0 005.098 1.825 6.854 6.854.0 001.314 6.609zM6.4 1.366a36.612 36.612.0 012.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799.0 006.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219A6.816 6.816.0 0013.29 3.692z"/></g></symbol><symbol id="icon-facebook" viewBox="0 0 16 16"><g><path d="M9.5 3H12V0H9.5C7.57.0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/></g></symbol><symbol id="icon-feed" viewBox="0 0 16 16"><g><path d="M2.13 11.733c-1.175.0-2.13.958-2.13 2.126.0 1.174.955 2.122 2.13 2.122a2.126 2.126.0 002.133-2.122A2.133 2.133.0 002.13 11.733zM.002 5.436v3.067c1.997.0 3.874.781 5.288 2.196a7.45 7.45.0 012.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006.0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824.0.006.0z"/></g></symbol><symbol id="icon-flickr" viewBox="0 0 16 16"><g><path d="M0 8.5a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0zm9 0a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0z"/></g></symbol><symbol id="icon-github" viewBox="0 0 16 16"><g><path d="M8 .198A8 8 0 005.471 15.789c.4.074.547-.174.547-.385.0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954.0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117.0.0.672-.215 2.201.82A7.672 7.672.0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147.0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481.0 1.07-.009 1.932-.009 2.195.0.213.144.462.55.384A8 8 0 008.001.196z"/></g></symbol><symbol id="icon-gitlab" viewBox="0 0 28 28"><g><path d="M1.625 11.031 14 26.89.437 17.046a1.092 1.092.0 01-.391-1.203l1.578-4.813zm7.219.0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548.0 011.031.0zm20.625 9.562 1.578 4.813a1.09 1.09.0 01-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548.0 011.031.0z"/></g></symbol><symbol id="icon-google-plus" viewBox="0 0 16 16"><g><path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737.0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991.0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784.0 5.059.0 7.875s2.275 5.091 5.091 5.091c2.937.0 4.888-2.066 4.888-4.975.0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/></g></symbol><symbol id="icon-instagram" viewBox="0 0 22 22"><g><path d="M15.445.0H6.554A6.559 6.559.0 000 6.554v8.891A6.559 6.559.0 006.554 22h8.891a6.56 6.56.0 006.554-6.555V6.554A6.557 6.557.0 0015.445.0zm4.342 15.445a4.343 4.343.0 01-4.342 4.342H6.554a4.341 4.341.0 01-4.341-4.342V6.554a4.34 4.34.0 014.341-4.341h8.891a4.342 4.342.0 014.341 4.341l.001 8.891z"/><path d="M11 5.312A5.693 5.693.0 005.312 11 5.694 5.694.0 0011 16.688 5.694 5.694.0 0016.688 11 5.693 5.693.0 0011 5.312zm0 9.163a3.475 3.475.0 11-.001-6.95 3.475 3.475.0 01.001 6.95zm5.7-10.484a1.363 1.363.0 11-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/></g></symbol><symbol id="icon-linkedin" viewBox="0 0 16 16"><g><path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502.0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5A1.5 1.5.0 11.999 3.499 1.5 1.5.0 014 3.5z"/></g></symbol><symbol id="icon-mail" viewBox="0 0 22 18"><g><path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275 5.077-5.09L1.795 3.98v10.155zm13.332-5.09 5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588 8.022-8.027-16.045-.001 8.023 8.028z"/></g></symbol><symbol id="icon-medium" viewBox="0 0 24 24"><g><path d="M22.085 4.733 24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244.0 01-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287.0.346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556.0 01-.214-.534V5.267a.554.554.0 01.213-.534z"/></g></symbol><symbol id="icon-npm" viewBox="0 0 16 16"><g><path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/></g></symbol><symbol id="icon-pinterest" viewBox="0 0 16 16"><g><path d="M8 1.069A6.93 6.93.0 005.475 14.453c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591.0.878.444.878.975.0.594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231.0 2.178-1.3 2.178-3.175.0-1.659-1.194-2.819-2.894-2.819-1.972.0-3.128 1.478-3.128 3.009.0.597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89.0 01-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684.0-2.188 1.587-4.194 4.578-4.194 2.403.0 4.272 1.712 4.272 4.003.0 2.388-1.506 4.313-3.597 4.313-.703.0-1.362-.366-1.588-.797.0.0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93.0 008.984-6.622A6.931 6.931.0 008.001 1.068z"/></g></symbol><symbol id="icon-search" viewBox="0 0 16 16"><g><path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 10-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 110-8 4 4 0 010 8z"/></g></symbol><symbol id="icon-strava" viewBox="0 0 24 24"><g><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599 2.836 5.598h4.172L10.463.0l-7 13.828h4.169"/></g></symbol><symbol id="icon-tumblr" viewBox="0 0 16 16"><g><path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81.0 1.289-.107 2.09-.633v2.405a9.089 9.089.0 01-1.833.639A7.93 7.93.0 019.369 16a4.9 4.9.0 01-1.725-.276 4.195 4.195.0 01-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386.0 001.08-1.374C6.133 1.505 6.32.825 6.422.0h2.579v4H13v3H9.001z"/></g></symbol><symbol id="icon-twitter" viewBox="0 0 16 16"><g><path d="M16 3.538a6.461 6.461.0 01-1.884.516 3.301 3.301.0 001.444-1.816 6.607 6.607.0 01-2.084.797 3.28 3.28.0 00-2.397-1.034A3.28 3.28.0 007.882 6.029 9.321 9.321.0 011.116 2.598a3.284 3.284.0 001.015 4.381A3.301 3.301.0 01.643 6.57v.041A3.283 3.283.0 003.277 9.83a3.291 3.291.0 01-1.485.057 3.293 3.293.0 003.066 2.281 6.586 6.586.0 01-4.862 1.359 9.286 9.286.0 005.034 1.475c6.037.0 9.341-5.003 9.341-9.341.0-.144-.003-.284-.009-.425a6.59 6.59.0 001.637-1.697z"/></g></symbol><symbol id="icon-vimeo" viewBox="0 0 16 16"><g><path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931.0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119.0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334.0.838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98.0 00-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/></g></symbol><symbol id="icon-wordpress" viewBox="0 0 16 16"><g><path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693.0 002 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371.0-.537.418-1.037 1.008-1.037.027.0.052.003.078.005A6.064 6.064.0 008 2.156 6.036 6.036.0 002.987 4.79c.141.004.274.007.386.007.627.0 1.599-.074 1.599-.074.323-.018.361.444.038.482.0.0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304.0 01-.629-.055c-.323-.019-.285-.5.038-.482.0.0.991.074 1.58.074.627.0 1.599-.074 1.599-.074.323-.018.362.444.038.482.0.0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806-1.8 5.095a6.148 6.148.0 003.687-.093.52.52.0 01-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601.0.593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697.0 00-.735-2.803zM8 0a8 8 0 100 16A8 8 0 008 0zm0 15A7 7 0 118 1a7 7 0 010 14z"/></g></symbol><symbol id="icon-youtube" viewBox="0 0 16 16"><g><path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359.0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/></g></symbol></svg><header class=l-header><div class=header-row><p class="c-title p-title p-title--small"><a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/ class=p-title__link>dwmkerr.com</a></p><nav class=header-icons><ul class=c-links><li class=c-links__item><a href=https://github.com/dwmkerr target=_blank title=GitHub><svg viewBox="0 0 16 16" class="c-links__icon"><path d="M8 .198A8 8 0 005.471 15.789c.4.074.547-.174.547-.385.0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954.0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117.0.0.672-.215 2.201.82A7.672 7.672.0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147.0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481.0 1.07-.009 1.932-.009 2.195.0.213.144.462.55.384A8 8 0 008.001.196z"/></svg></a></li><li class=c-links__item><a href=https://linkedin.com/in/dwmkerr target=_blank title=LinkedIn><svg viewBox="0 0 16 16" class="c-links__icon"><path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502.0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5A1.5 1.5.0 11.999 3.499 1.5 1.5.0 014 3.5z"/></svg></a></li><li class=c-links__item><a href=https://amzn.to/4ho0F91 target=_blank title="My Book on Amazon"><svg viewBox="0 0 512 512" class="c-links__icon c-links__icon--amazon"><path d="M283 187c-62 2-121 19-121 81 0 43 26 64 61 64 31 0 51-12 68-30 8 11 10 16 24 27 3 2 8 2 10-1l31-27c4-3 2-8 0-10-7-11-15-19-15-39v-64c0-27 2-52-18-70-17-16-38-20-62-21-53-1-88 28-93 62-1 6 4 9 7 9l37 5c6 1 9-4 10-8 6-22 29-28 43-23 20 6 18 29 18 45zm-36 105c-15 0-25-13-25-30 1-36 29-42 61-42v18c0 32-17 54-36 54zm168 106c13-11 26-38 25-57 0-7-1-8-8-10-13-4-46-5-62 10-3 3-2 5 1 5 11-2 45-6 50 2 4 7-8 35-12 47-2 5 2 6 6 3zM58 342c96 91 247 94 345 25 7-4 0-12-6-9A376 376 0 0162 337c-4-3-8 2-4 5z"/></svg></a></li></ul></nav></div></header><main id=main class=l-main><article class=p-article><header><h1>Learn Docker by building a Microservice</h1></header><section id=js-article class=p-article__body><p>If you are looking to get your hands dirty and learn all about <a href=https://docker.com>Docker</a>, then look no further!</p><p>In this article I&rsquo;m going to show you how Docker works, what all the fuss is about, and how Docker can help with a basic development task - building a microservice.</p><p>We&rsquo;ll use a simple Node.js service with a MySQL backend as an example, going from code running locally to containers running a microservice and database.</p><p align=center><img src=images/Article.png></p><p>Once you&rsquo;ve read the article, you can find the source code here:</p><p><a href=https://github.com/dwmkerr/node-docker-microservice>github.com/dwmkerr/node-docker-microservice</a></p><h2 id=what-is-docker>What is Docker?</h2><p>At its heart, Docker is software which lets you create an <em>image</em> (which is a lot like a template for a virtual machine) and then run instances of that image in a <em>container</em>.</p><p>Docker maintains a vast repository of images, called the <a href=https://hub.docker.com>Docker Hub</a> which you can use as starting points or as free storage for your own images. You can install Docker, choose an image you&rsquo;d like to use, then run an instance of it in a container.</p><p>We&rsquo;re going to build images, create containers from images and more in this article.</p><h3 id=install-docker>Install Docker</h3><p>To follow along and use this article, you&rsquo;ll need Docker.</p><p>Check the installation guide for your platform, <a href=https://docs.docker.com/engine/installation/>docs.docker.com/engine/installation</a>.</p><p>If you are on Mac or Windows, consider using a Virtual Machine. I use Parallels on Mac OS X to run an Ubuntu machine for most development activities. Being able to take snapshots, break things and then revert back is very handy when experimenting.</p><h3 id=try-it-out>Try It Out</h3><p>Enter this command:</p><pre tabindex=0><code>docker run -it ubuntu
</code></pre><p>After a bit of spinning, you&rsquo;ll see a prompt like this:</p><pre tabindex=0><code>root@719059da250d:/# 
</code></pre><p>Try out a few commands and then exit the container:</p><pre tabindex=0><code>root@719059da250d:/# lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 14.04.4 LTS
Release:	14.04
Codename:	trusty
root@719059da250d:/# exit
</code></pre><p>This doesn&rsquo;t look like much, but a lot has happened!</p><p>What you are seeing is the bash shell of an <em>isolated</em> container running Ubuntu, on your machine. It&rsquo;s yours to place with - you can install things on it, run software, whatever you want.</p><p>Here&rsquo;s a diagram and breakdown of what just happened (the digram is from the <a href=https://docs.docker.com/v1.8/introduction/understanding-docker/>&lsquo;Understanding the Architecture&rsquo; Docker Documentation</a>, which is great):</p><p><img src=images/Flow.png alt="Docker Run Flow"></p><ol><li>We issue a docker command:</li></ol><ul><li><code>docker</code>: run the docker client</li><li><code>run</code>: the command to run a new container</li><li><code>-it</code>: option to give the container an interactive terminal</li><li><code>ubuntu</code>: the image to base the container on</li></ul><ol start=2><li>The docker service running on the host (our machine) checks to see if we have a copy of the requested image locally- which there isn&rsquo;t.</li><li>The docker service checks the public registry (the docker hub) to see if there&rsquo;s an image named <code>ubuntu</code> available- which there is.</li><li>The docker service downloads the image and stores it in its local cache of images (ready for next time).</li><li>The docker service creates a new container, based on the <code>ubuntu</code> image.</li></ol><p>Try any of these:</p><pre tabindex=0><code>docker run -it haskell
docker run -it java
docker run -it python
</code></pre><p>We&rsquo;re not going to use <a href=https://xkcd.com/1312/>Haskell</a> today, but you can see, running an environment is very easy.</p><p>It&rsquo;s a snap to build images of our own, with our apps or services on them, databases, whatever we need. We can then run them on any machine with Docker installed - and the image will run in the same, predictable way. We can build our software <em>and the environment it runs on</em> as code and deploy easily.</p><p>Let&rsquo;s look into a simple microservice as an example.</p><h2 id=the-brief>The Brief</h2><p>We&rsquo;re going to build a microservice which lets us manage a directory of email addresses to phone numbers, using Node.js and MySQL.</p><h2 id=getting-started>Getting Started</h2><p>For doing local development we&rsquo;ll need to install MySQL and create a test database for us to&mldr;</p><p>&mldr;nope.</p><p>Creating a local database and running scripts on it is an easy start, but can get messy. Lots of uncontrolled stuff going on. It might work, we could even control it with some shell scripts checked in to our repo, but what if other developers already have MySQL installed? What if they have a database already with the creative name &lsquo;users&rsquo; which we want to create?</p><h3 id=step-1-creating-a-test-database-server---in-docker>Step 1: Creating a Test Database Server - in Docker</h3><p>This is a great Docker use case. We might not want to run our production database in Docker (perhaps we&rsquo;ll just use Amazon RDS for example), but we can spin up a clean MySQL database in no time as a Docker container for development - leaving our development machine clean and keeping everything we do controlled and repeatable.</p><p>Run the following command:</p><pre tabindex=0><code>docker run --name db -d -e MYSQL_ROOT_PASSWORD=123 -p 3306:3306 mysql:latest
</code></pre><p>This starts a MySQL instance running, allowing access through port 3306 using the root password 123.</p><ol><li><code>docker run</code> tells the engine we want to run an image (the image comes at the end, <a href=https://hub.docker.com/_/mysql/>mysql:vlatest</a></li><li><code>--name db</code> names this container <code>db</code>.</li><li><code>-d</code> (or <code>--detach</code>) detach - i.e. run the container in the background.</li><li><code>-e MYSQL_ROOT_PASSWORD=123</code> (or <code>--env</code>) environment variables - tells docker we want to provide an environment variable. The variable following it is what the MySQL image checks for setting the default root password.</li><li><code>-p 3306:3306</code> (or <code>--publish</code> tells the engine that we want to map the port 3306 from inside the container to out port 3306.</li></ol><p>The last part is really important - even though that&rsquo;s the MySQL default port, if we don&rsquo;t tell docker explicitly we want to map it, it will block access through that port (because containers are isolated until you tell them you want access).</p><p>The return value of this function is the <em>container id</em>, a reference to the container which you can use to stop it, restart it, issue commands on it and so on. Let&rsquo;s see which containers are running:</p><pre tabindex=0><code>$ docker ps
CONTAINER ID  IMAGE         ...  NAMES
36e68b966fd0  mysql:latest  ...  db
</code></pre><p>The key information is the container ID, image and name. Let&rsquo;s connect to this image and see what&rsquo;s there:</p><pre tabindex=0><code>$ docker exec -it db /bin/bash

root@36e68b966fd0:/# mysql -uroot -p123
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
+--------------------+
1 rows in set (0.01 sec)

mysql&gt; exit
Bye
root@36e68b966fd0:/# exit
</code></pre><p>This is pretty clever too:</p><ol><li><code>docker exec -it db</code> tells docker we want to execute a command on the container named <code>db</code> (we could also use the id, or just the first few letters of the id). <code>-it</code> ensures we have an interactive terminal.</li><li><code>mysql -uroot -p123</code> the command we actually run as a process in the container, which in this case is just the mysql client.</li></ol><p>We can create databases, tables, users, whatever we need.</p><h3 id=wrapping-up-the-test-database>Wrapping up the Test Database</h3><p>Running MySQL inside a container has already introduced a few Docker tricks, but let&rsquo;s pause here and move onto the service. For now, we&rsquo;ll have create a <code>test-database</code> folder with a script to start the database, stop the database and setup test data:</p><pre tabindex=0><code>test-database\setup.sql
test-database\start.sh
test-database\stop.sh
</code></pre><p>Start is simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run the MySQL container, with a database named &#39;users&#39; and credentials</span>
</span></span><span style=display:flex><span><span style=color:#75715e># for a users-service user which can access it.</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Starting DB...&#34;</span>
</span></span><span style=display:flex><span>docker run --name db -d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -e MYSQL_ROOT_PASSWORD<span style=color:#f92672>=</span><span style=color:#ae81ff>123</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -e MYSQL_DATABASE<span style=color:#f92672>=</span>users -e MYSQL_USER<span style=color:#f92672>=</span>users_service -e MYSQL_PASSWORD<span style=color:#f92672>=</span><span style=color:#ae81ff>123</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -p 3306:3306 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  mysql:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wait for the database service to start up.</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Waiting for DB to start up...&#34;</span>
</span></span><span style=display:flex><span>docker exec db mysqladmin --silent --wait<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span> -uusers_service -p123 ping <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run the setup script.</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Setting up initial data...&#34;</span>
</span></span><span style=display:flex><span>docker exec -i db mysql -uusers_service -p123 users &lt; setup.sql
</span></span></code></pre></div><p>This script runs the database image in a detached container (i.e. in the background), with a user set up to access a <code>users</code> database, then waits for the database server to start up, then runs a <code>setup.sql</code> script to set initial data.</p><p><code>setup.sql</code> is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> directory (user_id INT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>, email TEXT, phone_number TEXT);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> directory (email, phone_number) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#39;homer@thesimpsons.com&#39;</span>, <span style=color:#e6db74>&#39;+1 888 123 1111&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> directory (email, phone_number) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#39;marge@thesimpsons.com&#39;</span>, <span style=color:#e6db74>&#39;+1 888 123 1112&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> directory (email, phone_number) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#39;maggie@thesimpsons.com&#39;</span>, <span style=color:#e6db74>&#39;+1 888 123 1113&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> directory (email, phone_number) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#39;lisa@thesimpsons.com&#39;</span>, <span style=color:#e6db74>&#39;+1 888 123 1114&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> directory (email, phone_number) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#39;bart@thesimpsons.com&#39;</span>, <span style=color:#e6db74>&#39;+1 888 123 1115&#39;</span>);
</span></span></code></pre></div><p>The <code>stop.sh</code> script will stop the container and remove it (containers are left around by docker by default so that they can be restared quickly, we don&rsquo;t really need that feature for this example):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Stop the db and remove the container.</span>
</span></span><span style=display:flex><span>docker stop db <span style=color:#f92672>&amp;&amp;</span> docker rm db
</span></span></code></pre></div><p>We&rsquo;re going to make this even more slick later on, simplifying this further. Check the code at this stage by looking at the <a href=https://github.com/dwmkerr/node-docker-microservice/tree/step1>step1</a> branch of the repo.</p><h3 id=step-2-creating-a-microservice-in-nodejs>Step 2: Creating a Microservice in Node.js</h3><p>This article is really focused on learning Docker, so I&rsquo;m not going to spend ages on the Node.js microservice. Instead, I&rsquo;ll highlight the areas and takeaways.</p><pre tabindex=0><code>test-database/          # contains the code seen in Step 1
users-service/          # root of our node.js microservice
- package.json          # dependencies, metadata
- index.js              # main entrypoint of the app
- api/                  # our apis and api tests
- config/               # config for the app
- repository/           # abstraction over our db
- server/               # server setup code
</code></pre><p>Let&rsquo;s take this apart bit by bit. The first section to look at is <code>repository</code>. It can be useful to wrap your database access in some kind of class or abstraction, to allow to mock it for testing purposes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//  repository.js
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  Exposes a single function - &#39;connect&#39;, which returns
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  a connected repository. Call &#39;disconnect&#39; on this object when you&#39;re done.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mysql</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mysql&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  Class which holds an open connection to a repository
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  and exposes some simple functions for accessing data.
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Repository</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>connection</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connection</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUsers</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;SELECT email, phone_number FROM directory&#39;</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>results</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;An error occured getting the users: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>err</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>((<span style=color:#a6e22e>results</span> <span style=color:#f92672>||</span> []).<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>phone_number</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>phone_number</span>
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        }));
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUserByEmail</span>(<span style=color:#a6e22e>email</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//  Fetch the customer.
</span></span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;SELECT email, phone_number FROM directory WHERE email = ?&#39;</span>, [<span style=color:#a6e22e>email</span>], (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>results</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;An error occured getting the user: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>err</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>(<span style=color:#66d9ef>undefined</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>phone_number</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>phone_number</span>
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>disconnect</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  One and only exported function, returns a connected repo.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>connect</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>connectionSettings</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>connectionSettings</span>.<span style=color:#a6e22e>host</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;A host must be specified.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>connectionSettings</span>.<span style=color:#a6e22e>user</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;A user must be specified.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>connectionSettings</span>.<span style=color:#a6e22e>password</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;A password must be specified.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>connectionSettings</span>.<span style=color:#a6e22e>port</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;A port must be specified.&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Repository</span>(<span style=color:#a6e22e>mysql</span>.<span style=color:#a6e22e>createConnection</span>(<span style=color:#a6e22e>connectionSettings</span>)));
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>There&rsquo;s probably a lot of better ways to do this! But basically we can create a <code>Repository</code> object like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>connect</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>database</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;users&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;users_service&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>repo</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>getUsers</span>().<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>users</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>users</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>getUserByEmail</span>(<span style=color:#e6db74>&#39;homer@thesimpsons.com&#39;</span>).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#75715e>//  ...when you are done...
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>repo</span>.<span style=color:#a6e22e>disconnect</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>There&rsquo;s also a set of unit tests in the <code>repository/repository.spec.js</code> file. Now that we&rsquo;ve got a repo, we can create a server. This is <code>server/server.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//  server.js
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>morgan</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;morgan&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>start</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>options</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  Make sure we have a repository and port provided.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>repository</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;A server must be started with a connected repository.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>port</span>) <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;A server must be started with a port.&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  Create the app, add some logging.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>morgan</span>(<span style=color:#e6db74>&#39;dev&#39;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  Add the APIs to the app.
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;../api/users&#39;</span>)(<span style=color:#a6e22e>app</span>, <span style=color:#a6e22e>options</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  Start the app, creating a running server which we return.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>port</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>server</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>This module exposes a <code>start</code> function, which we can use like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./server/server);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>server.start({port: 8080, repo: repository}).then((svr) =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  // we&#39;</span><span style=color:#a6e22e>ve</span> <span style=color:#a6e22e>got</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>running</span> <span style=color:#a6e22e>http</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>:</span>)
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Notice that <code>server.js</code> uses <code>api/users/js</code>? Here it is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//  users.js
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  Defines the users api. Add to a server by calling:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  require(&#39;./users&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  Only export - adds the API to the app with the given options.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>app</span>, <span style=color:#a6e22e>options</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/users&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>getUsers</span>().<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>users</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>user</span>) =&gt; { <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>phoneNumber</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>phone_number</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/search&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  Get the email.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>email</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>email</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>email</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;When searching for a user, the email must be specified, e.g: &#39;/search?email=homer@thesimpsons.com&#39;.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//  Get the user from the repo.
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>getUserByEmail</span>(<span style=color:#a6e22e>email</span>).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>) { 
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;User not found.&#39;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>send</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>phoneNumber</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>phone_number</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Both of these files have unit tests adjacent to the source.</p><p>We&rsquo;ll need config. Rather than using a specialised library, a simple file will do the trick - <code>config/config.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//  config.js
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  Simple application configuration. Extend as needed.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>8123</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>DATABASE_HOST</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>database</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;users&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;users_service&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;123&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>We can <code>require</code> config as needed. Currently, most config is hard coded, but as you can see from <code>port</code> it&rsquo;s easy to add environment variables as an option.</p><p>Final step - stringing it together with an <code>index.js</code> file which composes everything:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//	index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  Entrypoint to the application. Opens a repository to the MySQL
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  server and starts the server.
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./server/server&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>repository</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./repository/repository&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./config/config&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  Lots of verbose logging when we&#39;re starting up...
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;--- Customer Service---&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Connecting to customer repository...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//  Log unhandled exceptions.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;uncaughtException&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Unhandled Exception&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;unhandledRejection&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>promise</span>){
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Unhandled Rejection&#39;</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>connect</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>host</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>database</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>database</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>user</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>password</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>port</span>
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>repo</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Connected. Starting server...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>start</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>port</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>repository</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>repo</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>app</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Server started successfully, running on port &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>port</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;close&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>disconnect</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>We have a little error handling and beyond that we&rsquo;re just loading config, creating a repo and starting our server.</p><p>That&rsquo;s the microservice. It allows us to get all users, or search a user:</p><pre tabindex=0><code>HTTP GET /users                              # gets all users
HTTP GET /search?email=homer@thesimpons.com  # searches by email
</code></pre><p>If you checkout the code, you&rsquo;ll see that there&rsquo;s a few commands available for you:</p><pre tabindex=0><code>cd ./users-service
npm install         # setup everything
npm test 		   # unit test - no need for a test database running
npm start           # run the server - you must have a test database running
npm run debug       # run the server in debug mode, opens a browser with the inspector
npm run lint        # check to see if the code is beautiful
</code></pre><p>Asides from the code you&rsquo;ve seen we have:</p><ol><li>Node Inspector for debugging</li><li>Mocha/shoud/supertest for unit tests</li><li>ESLint for linting</li></ol><p>That&rsquo;s it!</p><p>Run the test database with:</p><pre tabindex=0><code>cd test-database/
./start.sh
</code></pre><p>Then the service with:</p><pre tabindex=0><code>cd ../users-service/
npm start
</code></pre><p>You can point your browser to <a href=http://localhost:8123/users>localhost:8123/users</a> and see it in action. If you are using Docker Machine (i.e. you&rsquo;re on Mac or Windows) then <code>localhost</code> won&rsquo;t work, you need the IP of the docker machine instead. You can use <code>docker-machine ip</code> to get it.</p><p>We&rsquo;ve whipped through building the service quickly. If you&rsquo;d like to see this code before we continue, check the <a href=https://github.com/dwmkerr/node-docker-microservice/tree/step2>step2</a> branch.</p><h1 id=step-3-dockerising-our-microservice>Step 3: Dockerising our Microservice</h1><p>OK now it gets fun!</p><p>So we have a microservice which we can run on a dev box, as long as it has a compatible version of Node.js installed. What we&rsquo;d like to do is set up our service so that we can create a <em>Docker Image</em> from it, allowing us to deploy our service anywhere which supports docker.</p><p>The way we do this is create a <em>Dockerfile</em>. A Dockerfile is a recipe that tells the Docker engine how to build your image. We&rsquo;ll create a simple Dockerfile in our <code>users-service</code> directory and start to explore how we can adapt it to our needs.</p><h2 id=creating-the-dockerfile>Creating the Dockerfile</h2><p>Create a new text file called <code>Dockerfile</code> at <code>users-service/</code> with the content below:</p><pre tabindex=0><code># Use Node v4 as the base image.
FROM node:4

# Run node 
CMD [&#34;node&#34;]
</code></pre><p>Now run the commands below to build the image and run the a container from it:</p><pre tabindex=0><code>docker build -t node4 .    # Builds a new image
docker run -it node4       # Run a container with this image, interactive
</code></pre><p>Let&rsquo;s look at the build command first.</p><ol><li><code>docker build</code> tell the engine we want to create a new image.</li><li><code>-t node4</code> tag this image with the tag <code>node4</code>. We can refer to this image by tag from now on.</li><li><code>.</code> use the current directory to find the <code>Dockerfile</code>.</li></ol><p>After some console output you&rsquo;ll see we have a new image created. You can see all images on your system with <code>docker images</code>. The next command should be fairly familiar from what we&rsquo;ve done so far:</p><ol><li><code>docker run</code> run a new container from an image.</li><li><code>-it</code> use an interactive terminal.</li><li><code>node4</code> the tag of the image we want to use in the container.</li></ol><p>When we run this image, we get a node repl, check the current version like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>version</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;v4.4.0&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><p>This is potentially different to the node version on your current machine.</p><h2 id=examining-the-dockerfile>Examining the Dockerfile</h2><p>Looking at the dockerfile we can see quite easily what is going on:</p><ol><li><code>FROM node:4</code> the first thing we specify in a Dockerfile is the base image. A quick google finds the <a href=https://hub.docker.com/_/node/>node organisation page on the docker hub</a> showing all of the available images. This is essentially bare bones ubuntu with node installed.</li><li><code>CMD ["node"]</code> the <code>CMD</code> command tells docker that this image should run the node executable. When the executable terminates, the container shuts down.</li></ol><p>With the addition of a few more commands, we can update our Dockerfile so that it runs our service:</p><pre tabindex=0><code># Use Node v4 as the base image.
FROM node:4

# Add everything in the current directory to our image, in the &#39;app&#39; folder.
ADD . /app

# Install dependencies
RUN cd /app; \
    npm install --production

# Expose our server port.
EXPOSE 8123

# Run our app.
CMD [&#34;node&#34;, &#34;/app/index.js&#34;]
</code></pre><p>The only addition here is that we use the <code>ADD</code> command to copy everything<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> in the current directory to a folder in the container called <code>app/</code> . We then use <code>RUN</code> to run a command in the image, which installs our modules. Finally, we <code>EXPOSE</code> the server port, telling docker we intend to support inbound connections on <code>8123</code>, then run our server code.</p><p>Ensure the test-database service is running, then build and run the image again:</p><pre tabindex=0><code>docker build -t users-service .
docker run -it -p 8123:8123 users-service
</code></pre><p>If you navigate to <code>localhost:8123/users</code> in a browser you should see an error, checking the console shows our container is reporting some issues:</p><pre tabindex=0><code>--- Customer Service---
Connecting to customer repository...
Connected. Starting server...
Server started successfully, running on port 8123.
GET /users 500 23.958 ms - 582
Error: An error occured getting the users: Error: connect ECONNREFUSED 127.0.0.1:3306
    at Query._callback (/app/repository/repository.js:21:25)
    at Query.Sequence.end (/app/node_modules/mysql/lib/protocol/sequences/Sequence.js:96:24)
    at /app/node_modules/mysql/lib/protocol/Protocol.js:399:18
    at Array.forEach (native)
    at /app/node_modules/mysql/lib/protocol/Protocol.js:398:13
    at nextTickCallbackWith0Args (node.js:420:9)
    at process._tickCallback (node.js:349:13)
</code></pre><p>Yikes! So the connection from our <code>users-service</code> container to the <code>test-database</code> container is being refused. We might try running <code>docker ps</code> to see all containers running:</p><pre tabindex=0><code>CONTAINER ID  IMAGE          PORTS                   NAMES
a97958850c66  users-service  0.0.0.0:8123-&gt;8123/tcp  kickass_perlman
47f91343db01  mysql:latest   0.0.0.0:3306-&gt;3306/tcp  db
</code></pre><p>They&rsquo;re both there, so what is going on?</p><h2 id=linking-containers>Linking Containers</h2><p>The issue we&rsquo;ve seen is actually to be expected. Docker containers are supposed to be isolated, so it wouldn&rsquo;t make much sense if we could create connections between containers without us explicitly allowing it.</p><p>Yes, we can connect from our machine (the host) to a container, because we&rsquo;ve opened ports for that (using the <code>-p 8123:8123</code> argument for example). If we allowed containers to talk to each other in the same way, then two containers running on the same machine would be able to communicate, even if the developers didn&rsquo;t intend it, and that&rsquo;s a recipe for disaster, especially when we might have a cluster of machines whos job it is to run containers from different applications.</p><p>If we&rsquo;re going to connect from one container to another, we need to <em>link</em> them, which tells docker that we explicitly want to allow communication between the two. There are two ways of doing this, the first is the &lsquo;old fasioned&rsquo; but quite simple way, the second we&rsquo;ll see a little later.</p><h3 id=linking-containers-with-the-link-parameter>Linking Containers with the &rsquo;link&rsquo; parameter</h3><p>When we run a container, we can tell docker that we intend to connect to another container using the <code>link</code> parameter. In our case, we can run our service correctly like this:</p><pre tabindex=0><code>docker run -it -p 8123:8123 --link db:db -e DATABASE_HOST=DB users-service
</code></pre><ol><li><code>docker run -it</code> run a docker image in a container, with an interactive terminal.</li><li><code>-p 8123:8123</code> map the host port 8123 to the container port 8123.</li><li><code>link db:db</code> link to the container named <code>db</code> and refer to it as <code>db</code>.</li><li><code>-e DATABASE_HOST=db</code> set the <code>DATABASE_HOST</code> environment variable to <code>db</code>.</li><li><code>users-service</code> the name of the image to run in our container.</li></ol><p>Now when we go to <code>localhost:8123/users</code> everything works.</p><h4 id=how-it-works>How it works</h4><p>Remember our config file for the service? It allowed us to specify a database host with an environment variable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//  config.js
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  Simple application configuration. Extend as needed.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PORT</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>8123</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>DATABASE_HOST</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>database</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;users&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;users_service&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;123&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>When we run the container, we set this environment variable to <code>DB</code>, which means we&rsquo;re connecting to a host called <code>DB</code>. This is <em>automatically</em> set up for us by the docker engine when we link to a container.</p><p>To see this in action, try running <code>docker ps</code> to list all running containers. Look up the name of the container running the <code>users-service</code>, which will be a random name such as <code>trusting_jang</code>:</p><pre tabindex=0><code>docker ps
CONTAINER ID  IMAGE          ...   NAMES
ac9449d3d552  users-service  ...   trusting_jang
47f91343db01  mysql:latest   ...   db
</code></pre><p>Now we can look at the hosts available on our container:</p><pre tabindex=0><code>docker exec trusting_jang cat /etc/hosts
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
ff00::0	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
172.17.0.2	db 47f91343db01    # linking magic!!
172.17.0.3	ac9449d3d552
</code></pre><p>Remember how <code>docker exec</code> works? Choose a container name and then whatever follows is the command you&rsquo;ll execute on the container, in our case <code>cat /etc/hosts</code>.</p><p>OK the hosts file doesn&rsquo;t have the <code># linking magic!!</code> comment, that&rsquo;s so you can see - docker has added <code>db</code> to our hosts file so we can refer to the linked container by hostname. This is one consequence of linking. Here&rsquo;s the other:</p><pre tabindex=0><code>docker exec trusting_jang printenv | grep DB
DB_PORT=tcp://172.17.0.2:3306
DB_PORT_3306_TCP=tcp://172.17.0.2:3306
DB_PORT_3306_TCP_ADDR=172.17.0.2
DB_PORT_3306_TCP_PORT=3306
DB_PORT_3306_TCP_PROTO=tcp
DB_NAME=/trusting_jang/db
</code></pre><p>From this command we can also see that when docker links a container, it also provides a set of environment variables with some helpful information. We know the host, tcp port and container name.</p><p>That&rsquo;s step 3 complete - we have a MySQL database running happily in a container, we have a node.js microservice which we can run locally or in a container of its own, and we know how to link them together.</p><p>You can check out how the code looks at this stage by going to the <a href=https://github.com/dwmkerr/node-docker-microservice/tree/step3>step3</a> branch.</p><h1 id=step-4-integration-testing-the-environment>Step 4: Integration Testing the Environment</h1><p>We can now write an integration test which calls the actual server, running as a docker container, calling the containerised test database.</p><p>Writing the integration test can be done in whatever language or on whatever platform you want, within reason, but to keep things simple I&rsquo;m using Node.js as we&rsquo;ve already seen Mocha and Supertest in our project.</p><p>In a new folder, called <code>integration-tests</code> we&rsquo;ve got a single <code>index.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>supertest</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;supertest&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>should</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;should&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;users-service&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>api</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>supertest</span>(<span style=color:#e6db74>&#39;http://localhost:8123&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;returns a 200 for a known user&#39;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/search?email=homer@thesimpsons.com&#39;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>done</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>This will check an API call and show the results of the test<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>As long as your <code>users-service</code> and <code>test-database</code> are running, the tests will pass. However, at this stage the services are getting a little harder to handle:</p><ol><li>We have to use a shell script to start and stop the database</li><li>We have to remember a sequence of commands to start the users service against the database</li><li>We have to use node directly to run the integration tests</li></ol><p>Now that we&rsquo;re a little more familiar with Docker we can fix these issues.</p><h3 id=simplifiying-the-test-database>Simplifiying the Test Database</h3><p>Currently we have the following files for the test database:</p><pre tabindex=0><code>/test-database/start.sh
/test-database/stop.sh
/test-database/setup.sql
</code></pre><p>Now that we&rsquo;re more familar with Docker, we can improve on this. Looking into the <a href=https://hub.docker.com/_/mysql/>mysql image documentation</a> on Docker Hub there&rsquo;s a note which tells us any <code>.sql</code> or <code>.sh</code> file added to the image&rsquo;s <code>/docker-entrypoint-initdb.d</code> folder will be executed when setting up the DB.</p><p>This means we can replace our <code>start.sh</code> and <code>stop.sh</code> scripts with a <code>Dockerfile</code>:</p><pre tabindex=0><code>FROM mysql:5

ENV MYSQL_ROOT_PASSWORD 123
ENV MYSQL_DATABASE users
ENV MYSQL_USER users_service
ENV MYSQL_PASSWORD 123

ADD setup.sql /docker-entrypoint-initdb.d
</code></pre><p>Now to run our test database it is just:</p><pre tabindex=0><code>docker build -t test-database .
docker run --name db test-database
</code></pre><h3 id=composing>Composing</h3><p>Building and running each container is still somewhat time consuming. We can take things a step further with the <a href=https://docs.docker.com/compose/>Docker Compose</a> tool.</p><p>Docker Compose lets you create a file which defines each container in your system, the relationships between them, and build or run them all.</p><p>First, <a href=https://docs.docker.com/compose/install/>install Docker Compose</a>. Now create a new file in the root of your project called <code>docker-compose.yml</code>:</p><pre tabindex=0><code>version: &#39;2&#39;
services:
  users-service:
    build: ./users-service
    ports:
     - &#34;8123:8123&#34;
    depends_on:
     - db
    environment:
     - DATABASE_HOST=db
  db:
    build: ./test-database
</code></pre><p>Now check this out:</p><pre tabindex=0><code>docker-compose build
docker-compose up
</code></pre><p>Docker Compose has built all of the images needed for our application, created containers fromthem, run them in the correct order and started the whole stack!</p><p>The <code>docker-compose build</code> command builds each image which is listed in the <code>docker-compose.yml</code> file:</p><pre tabindex=0><code>version: &#39;2&#39;
services:
  users-service:
    build: ./users-service
    ports:
     - &#34;8123:8123&#34;
    depends_on:
     - db
    environment:
     - DATABASE_HOST=db
  db:
    build: ./test-database
</code></pre><p>The <code>build</code> value for each of our services tells docker where to go to find the <code>Dockerfile</code>. When we run <code>docker-compose up</code>, docker starts all of our services. Notice from the <code>Dockerfile</code> we can specify ports and dependencies. Actually, there&rsquo;s a whole bunch of config we can change here.</p><p>In another terminal, run <code>docker compose down</code> to gracefully shut down the containers.</p><h1 id=winding-up>Winding Up</h1><p>We&rsquo;ve seen a lot of docker in this article, but there&rsquo;s a lot more to it. I hope this has shown some of the interesting and useful things that you can use docker for in your workflow.</p><p>As usual, questions and comments are welcomed! I&rsquo;d also strongly recommend the document <a href=https://docs.docker.com/engine/understanding-docker/>Understanding Docker</a> to get a deeper understanding of how docker works.</p><p>You can see the final source code for the project built in this article at <a href=https://github.com/dwmkerr/node-docker-microservice>github.com/dwmkerr/node-docker-microservice</a></p><h1 id=notes>Notes</h1><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Copying everything is actually a bad idea, because we will also copy the node_modules folder. Generally it is a better idea explicitly list the files or folders you want to copy, or use a .dockerignore file, which works just like the .gitignore file.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>If the server isn&rsquo;t running, it will actually show a rather annoying exception, due to a bug in supertest, see <a href=https://github.com/visionmedia/supertest/issues/314>github.com/visionmedia/supertest/issues/314</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><div class=c-tags><a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/node.js class=c-tag>Node.js</a>
<a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/javascript class=c-tag>Javascript</a>
<a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/docker class=c-tag>Docker</a>
<a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/unix class=c-tag>Unix</a>
<a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/devops class=c-tag>Devops</a>
<a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/mysql class=c-tag>MySQL</a>
<a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/tags/codeproject class=c-tag>CodeProject</a></div><div class=c-article-date><time datetime=2016-04-19T08:54:39Z>Apr 19, 2016</time></div><footer><div id=disqus_thread></div><script>var disqus_shortname="dwmkerr";(function(){var e=document,t=e.createElement("script");t.src="https://"+disqus_shortname+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><nav class="p-pagination c-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer><a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/moving-from-react-redux-to-angular-2/>Newer</a></div><div class=c-pagination__older><a href=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/getting-started-with-react/>Older</a></div></div></nav><section class=p-related><h3>See Also</h3><div class=p-related__list><div class="swiper swiper-container"><ul class=swiper-wrapper><li class="p-related__item swiper-slide"><a href=/dwmkerr.com/pr-preview/pr-61/getting-started-with-react/><span>Getting Started with React & ES6</span></a></li><li class="p-related__item swiper-slide"><a href=/dwmkerr.com/pr-preview/pr-61/modifying-a-jwt-in-a-node-application/><span>Manipulating JSON Web Tokens (JWTs)</span></a></li><li class="p-related__item swiper-slide"><a href=/dwmkerr.com/pr-preview/pr-61/the-best-module-system-for-angularjs-applications/><span>The Best Module System for AngularJS Applications</span></a></li><li class="p-related__item swiper-slide"><a href=/dwmkerr.com/pr-preview/pr-61/fixing-memory-leaks-in-angularjs-applications/><span>Fixing Memory Leaks in AngularJS and other JavaScript Applications</span></a></li><li class="p-related__item swiper-slide"><a href=/dwmkerr.com/pr-preview/pr-61/the-only-angularjs-modal-service-youll-ever-need/><span>The Only AngularJS Modal Service You'll Ever Need</span></a></li><li class="p-related__item swiper-slide"><a href=/dwmkerr.com/pr-preview/pr-61/node-js-and-express-strange-http-status-codes/><span>Node.js and Express - Strange Http Status Codes</span></a></li></ul></div><div class=related-prev></div><div class=related-next></div></div></section><aside class=p-author><div class="c-avatar p-author__avatar"><img alt="Author Avatar" src=/images/avatar.jpeg></div><div class=p-author__body><p class="c-title p-author__name">Dave Kerr</p><p>Climber, Coder, Technology Consultant. Views expressed are my own.</p></div></aside></footer></article></main><nav class="l-nav p-menu"><ul class=p-menu__lists><li class=p-menu__listitem><a href=/dwmkerr.com/pr-preview/pr-61/>Blog</a></li><li class=p-menu__listitem><a href=/dwmkerr.com/pr-preview/pr-61/page/about/>About</a></li></ul></nav><footer class=l-footer><ul class=c-links><li class=c-links__item><a href=https://github.com/dwmkerr target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>github</title><use xlink:href="#icon-github"/></svg></a></li><li class=c-links__item><a href=https://linkedin.com/in/dwmkerr target=_blank><svg viewBox="0 0 64 64" class="c-links__icon"><title>linkedin</title><use xlink:href="#icon-linkedin"/></svg></a></li></ul><p class=p-copyright>Copright &copy; Dave Kerr</p></footer><script type=text/javascript src=https://dwmkerr.github.io/dwmkerr.com/pr-preview/pr-61/js/bundle.js defer></script></body></html>