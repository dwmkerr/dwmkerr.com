<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Manipulating Istio and other Custom Kubernetes Resources in Golang &#183; Dave Kerr</title><meta name=description content="In this article I'll demonstrate how to use Golang to manipulate Kubernetes Custom Resources, with Istio as an example. No knowledge of Istio is needed, I'll just use it to demonstrate the concepts!
Istio is a highly popular Service Mesh platform which allows engineers to quickly add telemetry, advanced traffic management and more to their service-based applications.
One interesting element of how Istio works is that when deployed into a Kubernetes cluster, many key configuration objects are handled as Custom Resources."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.61.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Manipulating Istio and other Custom Kubernetes Resources in Golang"><meta property="og:description" content="In this article I'll demonstrate how to use Golang to manipulate Kubernetes Custom Resources, with Istio as an example. No knowledge of Istio is needed, I'll just use it to demonstrate the concepts!
Istio is a highly popular Service Mesh platform which allows engineers to quickly add telemetry, advanced traffic management and more to their service-based applications.
One interesting element of how Istio works is that when deployed into a Kubernetes cluster, many key configuration objects are handled as Custom Resources."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/manipulating-istio-and-other-custom-kubernetes-resources-in-golang/"><link rel=stylesheet href=http://example.org/dist/styles.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-41728580-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=dwmkerr.com href=http://example.org/>dwmkerr.com</a></h1><a class=button-square href=http://example.org/index.xml><i class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/dwmkerr rel=me><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/dwmkerr rel=me><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/1189164/dave-kerr rel=me><i class="fa fa-stack-overflow"></i></a><a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/dwmkerr/ rel=me><i class="fa fa-linkedin"></i></a></div><ul class=site-nav><li class=site-nav-item><a title=Blog href=/>Blog</a></li><li class=site-nav-item><a title=Speaking href=/page/speaking/>Speaking</a></li><li class=site-nav-item><a title=About href=/page/about/>About</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Manipulating Istio and other Custom Kubernetes Resources in Golang</h1><p class="post-date post-line"><span>Published <time datetime=2018-10-08 itemprop=datePublished>Mon, Oct 8, 2018</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/dwmkerr itemprop=url rel=author>Dave Kerr</a></span></span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=/images/2018/10/code-1.jpg><p>In this article I'll demonstrate how to use Golang to manipulate Kubernetes Custom Resources, with Istio as an example. No knowledge of Istio is needed, I'll just use it to demonstrate the concepts!</p><p><img src=/images/2018/10/code-2.jpg alt=code></p><p><a href=https://istio.io>Istio</a> is a highly popular Service Mesh platform which allows engineers to quickly add telemetry, advanced traffic management and more to their service-based applications.</p><p>One interesting element of how Istio works is that when deployed into a Kubernetes cluster, many key configuration objects are handled as <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>Custom Resources</a>. Custom Resources are a very powerful Kubernetes feature, which allow you to create your own &lsquo;first class&rsquo; resources (just like Pods, ReplicaSets, Deployments or whatever) and then interface with them using <code>kubectl</code> or the Kubernetes APIs.</p><p>In this article I'll show you how to interface with these Custom Resources using the Golang Kubernetes client.</p><h2 id=crds-a-quick-overview>CRDs: A Quick Overview</h2><p>When you set up Istio for your cluster, one common thing you will likely do is specify how you will route traffic. This can be quite sophisticated, as shown below:</p><p><img src=/images/2018/10/TrafficManagementOverview.svg alt=TrafficManagementOverview></p><p><a href=https://istio.io/docs/concepts/traffic-management/>Figure 1: Istio Traffic Management Examples, from istio.io</a></p><p>One way for a system like this to be configured would be to have a ConfigMap which contains the definition of how services are routed.</p><p>However, Istio actually registers new types of resources (Custom Resource Definitions) which represent things like Gateways or Services. We can create/update/delete/manipulate them just like any other Kubernetes object.</p><p>For example, I could create a virtual service for the example above with something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#e6db74>&lt;&lt; EOF | kubectl create -f -
</span><span style=color:#e6db74>apiVersion: networking.istio.io/v1alpha3
</span><span style=color:#e6db74>kind: VirtualService
</span><span style=color:#e6db74>metadata:
</span><span style=color:#e6db74>  name: service2
</span><span style=color:#e6db74>spec:
</span><span style=color:#e6db74>  hosts:
</span><span style=color:#e6db74>  - &#34;*&#34;
</span><span style=color:#e6db74>  gateways:
</span><span style=color:#e6db74>  - demo1-gateway
</span><span style=color:#e6db74>  http:
</span><span style=color:#e6db74>  - route:
</span><span style=color:#e6db74>    - destination:
</span><span style=color:#e6db74>        host: service2
</span><span style=color:#e6db74>        subset: v1
</span><span style=color:#e6db74>      weight: 95
</span><span style=color:#e6db74>    - destination:
</span><span style=color:#e6db74>        host: service2
</span><span style=color:#e6db74>        subset: v2
</span><span style=color:#e6db74>      weight: 5
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>Again, the important thing is not the specific content of this resource, more the fact that I can treat my Istio resources just like I would any other Kubernetes object:</p><pre><code>$ kubectl get virtualservices.networking.istio.io
NAME       AGE
service2   93s
</code></pre><p>Or:</p><pre><code>$ kubectl delete virtualservices.networking.istio.io/service2
</code></pre><p>I can use <code>edit</code>, <code>describe</code>, register lifecycle events, watch for changes, and so on.</p><h2 id=working-with-crds-in-golang>Working with CRDs in Golang</h2><p>The <a href=https://github.com/kubernetes/client-go>Golang Kubernetes Client</a> allows you to create strongly defined types which you can then use to interface with CRDs. An example is in the Red Hat blog post <a href=https://blog.openshift.com/kubernetes-deep-dive-code-generation-customresources/>Kubernetes Deep Dive: Code Generation for Custom Resources</a>.</p><p>This is an excellent approach, but can feel pretty heavy if you want to quickly access some data, and don't want to have to generate a lot of code.</p><p>There is an alternative, which is to use the <a href=https://github.com/kubernetes/client-go/blob/master/dynamic/interface.go><code>DynamicClient</code></a>. The <em>preferred</em> approach seems to be the first, which involves code generation, so little documentation exists for the second approach. However, it is actually very simple.</p><p>Here's an example of how you can list all Istio <code>VirtualService</code> resources, without having to generate any code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>import</span> (
	<span style=color:#a6e22e>metav1</span> <span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span style=color:#e6db74>&#34;k8s.io/client-go/dynamic&#34;</span>
)

<span style=color:#75715e>//  Create a Dynamic Client to interface with CRDs.
</span><span style=color:#75715e></span><span style=color:#a6e22e>dynamicClient</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dynamic</span>.<span style=color:#a6e22e>NewForConfig</span>(<span style=color:#a6e22e>config</span>)

<span style=color:#75715e>//  Create a GVR which represents an Istio Virtual Service.
</span><span style=color:#75715e></span><span style=color:#a6e22e>virtualServiceGVR</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>GroupVersionResource</span>{
	<span style=color:#a6e22e>Group</span>:    <span style=color:#e6db74>&#34;networking.istio.io&#34;</span>,
	<span style=color:#a6e22e>Version</span>:  <span style=color:#e6db74>&#34;v1alpha3&#34;</span>,
	<span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;virtualservices&#34;</span>,
}

<span style=color:#75715e>//  List all of the Virtual Services.
</span><span style=color:#75715e></span><span style=color:#a6e22e>virtualServices</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dynamicClient</span>.<span style=color:#a6e22e>Resource</span>(<span style=color:#a6e22e>virtualServiceGVR</span>).<span style=color:#a6e22e>Namespace</span>(<span style=color:#e6db74>&#34;default&#34;</span>).<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>metav1</span>.<span style=color:#a6e22e>ListOptions</span>{})
<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>virtualService</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>virtualServices</span>.<span style=color:#a6e22e>Items</span> {
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;VirtualService: %s\n&#34;</span>, <span style=color:#a6e22e>virtualService</span>.<span style=color:#a6e22e>GetName</span>())
}
</code></pre></div><p>This snippet omits setup and error-handling for clarity, the full example is in the <a href=https://gist.github.com/dwmkerr/09ac0fd98595460456e17d5ef0c77667>k8s-list-virtualservices.go</a> gist.</p><h2 id=patching-crds-in-golang>Patching CRDs in Golang</h2><p>You may have noticed that the <code>.Resource().Namespace().List()</code> code looks very similar to the structure for making API calls when using the Kubernetes <code>Clientset</code>. In fact, it is essentially the same. Looking at <a href=https://github.com/kubernetes/client-go/blob/master/dynamic/interface.go>the interface</a>, you can see you have all of the operations you'd expect:</p><ul><li><code>Create</code></li><li><code>Update</code></li><li><code>Delete</code></li><li><code>Get</code></li></ul><p>And so on. This is nice because you can use the same trick in my article &lsquo;<a href=https://www.dwmkerr.com/patching-kubernetes-resources-in-golang/>Patching Kubernetes Resources in Golang</a>&rsquo; to manipulate these entities, without ever having to create a structure to represent it.</p><p>Here's another abbreviated example, this time showing how we can adjust the weight of the routing from the services to 50%/50%:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>import</span> (
	<span style=color:#a6e22e>metav1</span> <span style=color:#e6db74>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span style=color:#e6db74>&#34;k8s.io/client-go/dynamic&#34;</span>
)

<span style=color:#75715e>//  Create a GVR which represents an Istio Virtual Service.
</span><span style=color:#75715e></span><span style=color:#a6e22e>virtualServiceGVR</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>GroupVersionResource</span>{
	<span style=color:#a6e22e>Group</span>:    <span style=color:#e6db74>&#34;networking.istio.io&#34;</span>,
	<span style=color:#a6e22e>Version</span>:  <span style=color:#e6db74>&#34;v1alpha3&#34;</span>,
	<span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;virtualservices&#34;</span>,
}

<span style=color:#75715e>//  Weight the two routes - 50/50.
</span><span style=color:#75715e></span><span style=color:#a6e22e>patchPayload</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>PatchUInt32Value</span>, <span style=color:#ae81ff>2</span>)
<span style=color:#a6e22e>patchPayload</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Op</span> = <span style=color:#e6db74>&#34;replace&#34;</span>
<span style=color:#a6e22e>patchPayload</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Path</span> = <span style=color:#e6db74>&#34;/spec/http/0/route/0/weight&#34;</span>
<span style=color:#a6e22e>patchPayload</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Value</span> = <span style=color:#ae81ff>50</span>
<span style=color:#a6e22e>patchPayload</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Op</span> = <span style=color:#e6db74>&#34;replace&#34;</span>
<span style=color:#a6e22e>patchPayload</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Path</span> = <span style=color:#e6db74>&#34;/spec/http/0/route/1/weight&#34;</span>
<span style=color:#a6e22e>patchPayload</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Value</span> = <span style=color:#ae81ff>50</span>
<span style=color:#a6e22e>patchBytes</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>patchPayload</span>)

<span style=color:#75715e>//  Apply the patch to the &#39;service2&#39; service.
</span><span style=color:#75715e></span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dynamicClient</span>.<span style=color:#a6e22e>Resource</span>(<span style=color:#a6e22e>virtualServiceGVR</span>).<span style=color:#a6e22e>Namespace</span>(<span style=color:#e6db74>&#34;default&#34;</span>).<span style=color:#a6e22e>Patch</span>(<span style=color:#e6db74>&#34;service2&#34;</span>, <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>JSONPatchType</span>, <span style=color:#a6e22e>patchBytes</span>)
</code></pre></div><p>See the full example in the gist <a href=https://gist.github.com/dwmkerr/7332888e092156ce8ce4ea551b0c321f>k8s-patch-virtualservice.go</a></p><p>After running the sample, you can use the Kubernetes CLI to verify the changes:</p><pre><code>$ kubectl get virtualservices.networking.istio.io/service2 -o yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  clusterName: &quot;&quot;
  creationTimestamp: 2018-10-08T09:53:16Z
  generation: 0
  name: service2
  namespace: default
  resourceVersion: &quot;487435&quot;
  selfLink: /apis/networking.istio.io/v1alpha3/namespaces/default/virtualservices/service2
  uid: fac5930c-cadf-11e8-90a2-42010a94005b
spec:
  gateways:
  - demo1-gateway
  hosts:
  - '*'
  http:
  - route:
    - destination:
        host: service2
        subset: v1
      weight: 50
    - destination:
        host: service2
        subset: v2
      weight: 50
</code></pre><h2 id=keep-it-simple>Keep It Simple!</h2><p>That's it! This trick made something I was working on a <em>lot</em> easier, but it took a little bit of experimentation to get right. I hope you find the approach useful. Please share any thoughts/questions in the comments.</p><h2 id=further-reading>Further Reading</h2><p>The following articles were using in working out this approach:</p><ul><li><a href=https://blog.openshift.com/kubernetes-deep-dive-code-generation-customresources/>Red Hat: Deep Dive: Code Generation for Custom Resources</a></li><li><a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>Kubernetes Docs: Custom Resources</a></li></ul></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/tags/Kubernetes/>Kubernetes</a>,
<a href=/tags/Golang/>Golang</a>,
<a href=/tags/Devops/>Devops</a>,
<a href=/tags/Docker/>Docker</a>,
<a href=/tags/CodeProject/>CodeProject</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Manipulating%20Istio%20and%20other%20Custom%20Kubernetes%20Resources%20in%20Golang&url=http%3a%2f%2fexample.org%2fmanipulating-istio-and-other-custom-kubernetes-resources-in-golang%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fexample.org%2fmanipulating-istio-and-other-custom-kubernetes-resources-in-golang%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dmwkerr"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title=dwmkerr.com href=http://example.org/>dwmkerr.com</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2019 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=http://example.org/js/jquery-1.11.3.min.js></script><script src=http://example.org/js/jquery.fitvids.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=http://example.org/js/scripts.js></script></body></html>